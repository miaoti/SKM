{%- comment -%}Precision Buy Buttons - Technical Command Center Design{%- endcomment -%}
<div class="buy-buttons-precision w-full" {{ block.shopify_attributes }}>
  {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" class="product-variant-id" data-variant-id>
    {%- unless product.has_only_default_variant -%}
      <div class="variant-options mb-4 space-y-3">
        {%- for option in product.options_with_values -%}
          {%- assign option_index = forloop.index0 -%}
          <fieldset class="variant-option-group" data-option-name="{{ option.name }}" data-option-index="{{ option_index }}">
            <legend class="text-xs font-bold uppercase tracking-wider text-gray-600 mb-2">{{ option.name }}</legend>
            <div class="flex flex-wrap gap-2">
              {%- for value in option.values -%}
                {%- assign option_available = false -%}
                {%- for variant in product.variants -%}
                  {%- assign variant_option_value = variant.options[option_index] -%}
                  {%- if variant.available and variant_option_value == value -%}
                    {%- assign option_available = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                <label class="variant-option-label relative cursor-pointer {% unless option_available %}opacity-50{% endunless %}">
                  <input type="radio" name="option{{ option.position }}" value="{{ value | escape }}" class="sr-only peer" {% if option.selected_value == value %}checked{% endif %} {% unless option_available %}disabled{% endunless %}>
                  <span class="block px-4 py-2 text-sm font-mono border border-gray-300 rounded-sm bg-white peer-checked:border-black peer-checked:bg-black peer-checked:text-white hover:border-gray-500 transition-colors {% unless option_available %}cursor-not-allowed{% endunless %}">{{ value }}</span>
                </label>
              {%- endfor -%}
            </div>
          </fieldset>
        {%- endfor -%}
      </div>
    {%- endunless -%}
    {%- comment -%} Render add-on options directly from Liquid {%- endcomment -%}
    {% assign addon_meta = product.metafields.custom.add_on_options %}
    {% if addon_meta and addon_meta.value != blank %}
      <div id="addon-options-container" class="addon-options mb-4 space-y-3">
        {% for addon in addon_meta.value %}
          <fieldset class="addon-option-group" data-addon-name="{{ addon.name }}">
            <legend class="text-xs font-bold uppercase tracking-wider text-blue-600 mb-2">
              {{ addon.name }} <span class="text-gray-400 font-normal">(optional)</span>
            </legend>
            <div class="flex flex-wrap gap-2">
              {%- comment -%} None option - default selected {%- endcomment -%}
              <label class="addon-option-label relative cursor-pointer">
                <input type="radio" 
                       name="addon_{{ addon.name | handleize }}" 
                       value="" 
                       data-price-modifier="0" 
                       class="sr-only peer addon-input"
                       checked>
                <span class="block px-4 py-2 text-sm font-mono border border-gray-300 rounded-sm bg-white peer-checked:border-black peer-checked:bg-black peer-checked:text-white hover:border-gray-500 transition-colors">
                  None
                </span>
              </label>
              {%- comment -%} Add-on value options {%- endcomment -%}
              {% for val in addon.values %}
                {% assign price_mod = addon.priceModifiers[val] | default: 0 %}
                <label class="addon-option-label relative cursor-pointer">
                  <input type="radio" 
                         name="addon_{{ addon.name | handleize }}" 
                         value="{{ val }}" 
                         data-price-modifier="{{ price_mod }}" 
                         class="sr-only peer addon-input">
                  <span class="block px-4 py-2 text-sm font-mono border border-blue-300 rounded-sm bg-white peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:text-white hover:border-blue-500 transition-colors">
                    {{ val }}{% if price_mod > 0 %}<span class="text-xs opacity-75 ml-1">(+${{ price_mod }})</span>{% endif %}
                  </span>
                </label>
              {% endfor %}
            </div>
          </fieldset>
        {% endfor %}
      </div>
    {% else %}
      <div id="addon-options-container" class="addon-options mb-4 space-y-3"></div>
    {% endif %}
    <div id="addon-properties"></div>
    <div class="tcc-buy-row">
      <div class="tcc-qty-selector">
        <button type="button" name="minus" class="tcc-qty-btn" onclick="this.nextElementSibling.stepDown()">âˆ’</button>
        <input type="number" name="quantity" value="1" min="1" class="tcc-qty-input">
        <button type="button" name="plus" class="tcc-qty-btn" onclick="this.previousElementSibling.stepUp()">+</button>
      </div>
      <button type="submit" name="add" class="tcc-add-btn" {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}>
        <span class="tcc-add-btn-text">
          {%- if product.selected_or_first_available_variant.available -%}
            <span class="default-text">Add to Cart</span>
            <span class="hover-text">Initiate Build</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="tcc-arrow"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
          {%- else -%}Sold Out{%- endif -%}
        </span>
      </button>
    </div>
    {%- if product.selected_or_first_available_variant.available == false -%}
      <div class="tcc-unavailable">[ STATUS: UNAVAILABLE ]</div>
    {%- endif -%}
  {%- endform -%}
</div>

<style>
  /* Technical Command Center Buy Buttons - Racing Edition */
  .tcc-buy-row {
    display: flex;
    gap: 16px;
    align-items: stretch;
  }
  
  .tcc-qty-selector {
    display: flex;
    align-items: center;
    border: 0.5px solid #E5E5E5;
    background: #fff;
    height: 56px;
  }
  
  .tcc-qty-btn {
    width: 44px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: #666;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .tcc-qty-btn:hover {
    background: #f5f5f5;
    color: #111;
  }
  
  .tcc-qty-input {
    width: 48px;
    height: 100%;
    border: none;
    border-left: 0.5px solid #E5E5E5;
    border-right: 0.5px solid #E5E5E5;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    color: #111;
    background: transparent;
    -moz-appearance: textfield;
  }
  
  .tcc-qty-input::-webkit-inner-spin-button,
  .tcc-qty-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  /* Racing Button */
  .tcc-add-btn {
    flex: 1;
    height: 56px;
    background: linear-gradient(135deg, #111111 0%, #1a1a1a 50%, #111111 100%);
    color: #fff;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Racing stripe sweep animation */
  .tcc-add-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, #CC0000, transparent);
    transition: left 0.5s ease;
  }
  
  .tcc-add-btn:hover::before {
    left: 100%;
  }
  
  /* Red underglow effect */
  .tcc-add-btn::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 10%;
    width: 80%;
    height: 4px;
    background: #CC0000;
    opacity: 0;
    filter: blur(8px);
    transition: opacity 0.3s ease;
  }
  
  .tcc-add-btn:hover::after {
    opacity: 1;
    animation: pulse-glow 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse-glow {
    0%, 100% { opacity: 0.6; transform: scaleX(0.8); }
    50% { opacity: 1; transform: scaleX(1); }
  }
  
  .tcc-add-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #1a1a1a 0%, #222222 50%, #1a1a1a 100%);
    box-shadow: 
      0 0 30px rgba(204, 0, 0, 0.4),
      0 4px 20px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }
  
  .tcc-add-btn:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 
      0 0 20px rgba(204, 0, 0, 0.3),
      0 2px 10px rgba(0, 0, 0, 0.2);
  }
  
  .tcc-add-btn:disabled {
    background: #444;
    cursor: not-allowed;
  }
  
  .tcc-add-btn-text {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    position: relative;
    z-index: 1;
  }
  
  .tcc-add-btn .default-text,
  .tcc-add-btn .hover-text {
    transition: all 0.3s ease;
  }
  
  .tcc-add-btn .hover-text {
    display: none;
  }
  
  .tcc-add-btn:hover .default-text {
    display: none;
  }
  
  .tcc-add-btn:hover .hover-text {
    display: inline;
    color: #CC0000;
    text-shadow: 0 0 10px rgba(204, 0, 0, 0.5);
  }
  
  .tcc-arrow {
    width: 18px;
    height: 18px;
    transition: transform 0.3s ease;
  }
  
  .tcc-add-btn:hover .tcc-arrow {
    transform: translateX(4px);
    filter: drop-shadow(0 0 4px rgba(204, 0, 0, 0.6));
  }
  
  .tcc-unavailable {
    margin-top: 12px;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: #CC0000;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  
  /* Mobile Racing Edition */
  @media (max-width: 768px) {
    .tcc-buy-row {
      flex-direction: column;
      gap: 16px;
    }
    
    .tcc-qty-selector {
      width: 100%;
      height: 56px;
      justify-content: center;
      border: 1px solid #E5E5E5;
    }
    
    .tcc-qty-btn {
      width: 60px;
      font-size: 24px;
      font-weight: 300;
    }
    
    .tcc-qty-input {
      width: 80px;
      font-size: 18px;
      font-weight: 600;
    }
    
    .tcc-add-btn {
      width: 100%;
      height: 72px !important;
      min-height: 72px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.2em;
      border-radius: 0;
      background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .tcc-add-btn::before {
      background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.8), transparent);
    }
    
    .tcc-add-btn::after {
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      filter: blur(4px);
    }
    
    .tcc-add-btn-text {
      gap: 14px;
    }
    
    .tcc-arrow {
      width: 22px;
      height: 22px;
    }
    
    /* Mobile tap feedback - racing red flash */
    .tcc-add-btn:active:not(:disabled) {
      background: linear-gradient(180deg, #CC0000 0%, #990000 100%);
      transform: scale(0.98);
      box-shadow: 
        0 0 30px rgba(204, 0, 0, 0.6),
        inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .tcc-add-btn:active .tcc-arrow {
      transform: translateX(8px);
    }
  }
  
  /* Small mobile */
  @media (max-width: 400px) {
    .tcc-add-btn {
      height: 68px !important;
      min-height: 68px;
      font-size: 14px;
    }
  }
</style>

<script>
(function() {
  var productJson = {{ product | json }};
  var form = document.getElementById('{{ product_form_id }}');
  if (!form) return;
  var variantInput = form.querySelector('[data-variant-id]');
  var addButton = form.querySelector('[name="add"]');
  var optionInputs = form.querySelectorAll('input[name^="option"]');
  var addonContainer = document.getElementById('addon-options-container');
  var addonPropertiesContainer = document.getElementById('addon-properties');
  var currentVariantPrice = productJson.variants[0] ? productJson.variants[0].price : 0;
  
  // B2B pricing data
  var isB2BUser = {% assign is_b2b = false %}{% if customer %}{% for tag in customer.tags %}{% assign tag_downcase = tag | downcase | strip %}{% if tag_downcase == 'b2b' or tag_downcase == 'wholesale' or tag_downcase == 'business' %}{% assign is_b2b = true %}{% break %}{% endif %}{% endfor %}{% endif %}{{ is_b2b }};
  var productB2bPrice = {{ product.metafields.custom.b2b_price.value | default: 'null' }};
  var productDiscountPrice = {{ product.metafields.custom.discount_price.value | default: 'null' }};
  
  // Variant-level B2B prices (built from Liquid)
  var variantB2bPrices = {
    {%- for variant in product.variants -%}
      "{{ variant.id }}": {{ variant.metafields.custom.b2b_price.value | default: 'null' }}{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  };
  
  // Variant-level discount prices (built from Liquid)
  var variantDiscountPrices = {
    {%- for variant in product.variants -%}
      "{{ variant.id }}": {{ variant.metafields.custom.discount_price.value | default: 'null' }}{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  };
  
  // Calculate effective price (in cents) for a specific variant
  function getEffectivePrice(variantPrice, variantId) {
    // Get variant-specific prices, fall back to product-level
    var variantB2b = variantId ? variantB2bPrices[variantId] : null;
    var variantDiscount = variantId ? variantDiscountPrices[variantId] : null;
    
    var b2bPrice = (variantB2b !== null && variantB2b !== undefined) ? variantB2b : productB2bPrice;
    var discountPrice = (variantDiscount !== null && variantDiscount !== undefined) ? variantDiscount : productDiscountPrice;
    
    if (!isB2BUser) {
      // Standard user - use discount price if available
      if (discountPrice !== null) {
        var discountCents = discountPrice * 100;
        var percentOff = Math.round((variantPrice - discountCents) / variantPrice * 100);
        return { 
          price: discountCents, 
          badge: percentOff > 0 ? percentOff + '% OFF' : 'ON SALE', 
          badgeColor: 'bg-green-600',
          showCrossed: true, 
          crossedPrice: variantPrice 
        };
      }
      return { price: variantPrice, badge: null, showCrossed: false, crossedPrice: null };
    }
    
    // B2B user pricing logic - compare B2B price vs discount price, show lower
    var b2bCents = b2bPrice !== null ? b2bPrice * 100 : null;
    var discountCents = discountPrice !== null ? discountPrice * 100 : null;
    
    if (b2bCents !== null && discountCents !== null) {
      if (b2bCents <= discountCents) {
        return { price: b2bCents, badge: 'WHOLESALE', badgeColor: 'bg-[#CC0000]', showCrossed: true, crossedPrice: variantPrice };
      } else {
        var percentOff = Math.round((variantPrice - discountCents) / variantPrice * 100);
        return { price: discountCents, badge: percentOff + '% OFF', badgeColor: 'bg-green-600', showCrossed: true, crossedPrice: variantPrice };
      }
    } else if (b2bCents !== null) {
      return { price: b2bCents, badge: 'WHOLESALE', badgeColor: 'bg-[#CC0000]', showCrossed: true, crossedPrice: variantPrice };
    } else if (discountCents !== null) {
      var percentOff = Math.round((variantPrice - discountCents) / variantPrice * 100);
      return { price: discountCents, badge: percentOff + '% OFF', badgeColor: 'bg-green-600', showCrossed: true, crossedPrice: variantPrice };
    }
    
    return { price: variantPrice, badge: null, showCrossed: false, crossedPrice: null };
  }
  
  // Add-on options are now rendered via Liquid, just need to bind events
  function initAddonOptions() {
    var addonInputs = document.querySelectorAll('#addon-options-container .addon-input');
    console.log('[Add-on] Found', addonInputs.length, 'addon inputs');
    if (addonInputs.length === 0) return;
    
    addonInputs.forEach(function(inp) {
      inp.addEventListener('change', function() { 
        console.log('[Add-on] Selection changed:', this.value, 'Price mod:', this.dataset.priceModifier);
        updatePriceWithAddons(); 
        updateAddonProperties(); 
      });
    });
    // Initialize properties on load
    updateAddonProperties();
  }
  
  function getAddonPriceModifier() {
    var t = 0;
    document.querySelectorAll('#addon-options-container .addon-input:checked').forEach(function(i) { 
      var pm = parseFloat(i.dataset.priceModifier) || 0;
      t += pm;
    });
    return t * 100; // Convert to cents
  }
  
  function updateAddonProperties() {
    if (!addonPropertiesContainer) return;
    addonPropertiesContainer.innerHTML = '';
    form.querySelectorAll('fieldset.addon-option-group').forEach(function(f) {
      var n = f.dataset.addonName, c = f.querySelector('input:checked');
      // Only add property if a value is selected (not "None" which has empty value)
      if (c && n && c.value) {
        var m = parseFloat(c.dataset.priceModifier) || 0;
        var inp = document.createElement('input');
        inp.type = 'hidden'; 
        inp.name = 'properties[' + n + ']';
        inp.value = c.value + (m > 0 ? ' (+$' + m.toFixed(2) + ')' : '');
        addonPropertiesContainer.appendChild(inp);
      }
    });
    var tm = getAddonPriceModifier() / 100;
    if (tm > 0) {
      var p = document.createElement('input');
      p.type = 'hidden'; 
      p.name = 'properties[_addon_price]'; 
      p.value = tm.toFixed(2);
      addonPropertiesContainer.appendChild(p);
    }
    
    // Store effective price for cart display (variant-specific B2B/discount price)
    var currentVariantId = variantInput ? variantInput.value : null;
    var pricing = getEffectivePrice(currentVariantPrice, currentVariantId);
    var effectivePriceDollars = (pricing.price / 100).toFixed(2);
    
    // Always store the effective price so cart can use it
    var effectivePriceInput = document.createElement('input');
    effectivePriceInput.type = 'hidden';
    effectivePriceInput.name = 'properties[_effective_price]';
    effectivePriceInput.value = effectivePriceDollars;
    addonPropertiesContainer.appendChild(effectivePriceInput);
    
    // Store original price for crossed-out display
    var originalPriceDollars = (currentVariantPrice / 100).toFixed(2);
    var originalPriceInput = document.createElement('input');
    originalPriceInput.type = 'hidden';
    originalPriceInput.name = 'properties[_original_price]';
    originalPriceInput.value = originalPriceDollars;
    addonPropertiesContainer.appendChild(originalPriceInput);
    
    // Store badge info if applicable
    if (pricing.badge) {
      var badgeInput = document.createElement('input');
      badgeInput.type = 'hidden';
      badgeInput.name = 'properties[_price_badge]';
      badgeInput.value = pricing.badge;
      addonPropertiesContainer.appendChild(badgeInput);
    }
  }
  
  function updatePriceWithAddons() {
    var pd = document.getElementById('product-price-display');
    if (!pd) return;
    var pe = pd.querySelector('[data-product-price]');
    var currentVariantId = variantInput ? variantInput.value : null;
    var pricing = getEffectivePrice(currentVariantPrice, currentVariantId);
    if (pe) pe.textContent = formatMoney(pricing.price + getAddonPriceModifier());
  }
  
  function getSelectedOptions() {
    var o = [];
    form.querySelectorAll('fieldset.variant-option-group').forEach(function(f) {
      var c = f.querySelector('input:checked');
      if (c) o.push(c.value);
    });
    return o;
  }
  
  function findVariant(o) {
    return productJson.variants.find(function(v) {
      return o.every(function(opt, i) { return v.options[i] === opt; });
    });
  }
  
  function formatMoney(c) {
    var d = (c / 100).toFixed(2);
    return String.fromCharCode(36) + d.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }
  
  function updateVariant() {
    var o = getSelectedOptions();
    var v = findVariant(o);
    if (!v) return;
    variantInput.value = v.id;
    currentVariantPrice = v.price;
    try { var u = new URL(window.location); u.searchParams.set('variant', v.id); window.history.replaceState({}, '', u); } catch(e) {}
    var pd = document.getElementById('product-price-display');
    if (pd) {
      var pe = pd.querySelector('[data-product-price]');
      var ce = pd.querySelector('[data-compare-price]');
      var badgeEl = pd.querySelector('.price-badge');
      
      // Get effective price based on B2B status and variant-specific B2B price
      var pricing = getEffectivePrice(v.price, v.id);
      var displayPrice = pricing.price + getAddonPriceModifier();
      
      if (pe) {
        pe.textContent = formatMoney(displayPrice);
        // Update price color based on whether there's a special price
        if (pricing.showCrossed) {
          pe.classList.remove('text-black');
          pe.classList.add('text-[#CC0000]');
        } else {
          pe.classList.remove('text-[#CC0000]');
          pe.classList.add('text-black');
        }
      }
      
      // Update crossed out price
      if (pricing.showCrossed && pricing.crossedPrice) {
        if (ce) {
          ce.textContent = formatMoney(pricing.crossedPrice);
          ce.style.display = '';
        }
      } else if (v.compare_at_price && v.compare_at_price > v.price && !pricing.showCrossed) {
        if (ce) { ce.textContent = formatMoney(v.compare_at_price); ce.style.display = ''; }
      } else if (ce) {
        ce.style.display = 'none';
      }
      
      // Update or create badge
      if (pricing.badge) {
        if (!badgeEl) {
          badgeEl = document.createElement('span');
          badgeEl.className = 'price-badge ml-2 inline-block text-white text-[10px] px-2 py-0.5 uppercase tracking-wider font-bold';
          badgeEl.style.clipPath = 'polygon(0 0, 100% 0, 95% 50%, 100% 100%, 0 100%, 5% 50%)';
          pd.appendChild(badgeEl);
        }
        // Update badge color based on pricing type
        badgeEl.classList.remove('bg-[#CC0000]', 'bg-green-600');
        badgeEl.classList.add(pricing.badgeColor || 'bg-[#CC0000]');
        badgeEl.textContent = pricing.badge;
        badgeEl.style.display = '';
      } else if (badgeEl) {
        badgeEl.style.display = 'none';
      }
    }
    var sd = document.getElementById('product-sku-display');
    if (sd) sd.innerHTML = v.sku ? 'SKU: <span class="text-black font-bold">' + v.sku + '</span>' : '';
    var ad = document.getElementById('product-availability-display');
    if (ad) {
      var q = v.inventory_quantity || '1+';
      ad.innerHTML = v.available ? 'Availability: <span class="text-green-600 font-bold uppercase">In Stock (' + q + ')</span>' : 'Availability: <span class="text-red-600 font-bold uppercase">Out of Stock</span>';
    }
    if (v.available) {
      addButton.disabled = false;
      addButton.querySelector('span').innerHTML = '<span class="group-hover:hidden">Add to Cart</span><span class="hidden group-hover:inline">Initiate Build</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>';
    } else {
      addButton.disabled = true;
      addButton.querySelector('span').textContent = 'Sold Out';
    }
    var oo = {};
    form.querySelectorAll('fieldset.variant-option-group').forEach(function(f) { var n = f.dataset.optionName; var c = f.querySelector('input:checked'); if (c) oo[n] = c.value; });
    document.dispatchEvent(new CustomEvent('variant:change', { detail: { variant: v, options: oo } }));
  }
  
  optionInputs.forEach(function(i) { i.addEventListener('change', updateVariant); });
  var up = new URLSearchParams(window.location.search);
  var vi = up.get('variant');
  if (vi) {
    var vf = productJson.variants.find(function(v) { return String(v.id) === vi; });
    if (vf) {
      vf.options.forEach(function(o, i) { var inp = form.querySelector('input[name="option' + (i + 1) + '"][value="' + o + '"]'); if (inp) inp.checked = true; });
      variantInput.value = vf.id;
      currentVariantPrice = vf.price;
    }
  }
  
  // Initialize add-on options (rendered via Liquid, just bind events)
  initAddonOptions();
  
  // Trigger initial variant update to ensure correct pricing on page load
  updateVariant();
  
  // Debug logging for variant prices
  console.log('[Pricing Debug] isB2BUser:', isB2BUser);
  console.log('[Pricing Debug] productB2bPrice:', productB2bPrice);
  console.log('[Pricing Debug] productDiscountPrice:', productDiscountPrice);
  console.log('[Pricing Debug] variantB2bPrices:', variantB2bPrices);
  console.log('[Pricing Debug] variantDiscountPrices:', variantDiscountPrices);
})();
</script>