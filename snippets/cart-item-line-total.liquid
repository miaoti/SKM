{%- doc -%}
  Cart Item Line Total with B2B and Discount Logic
  
  This snippet calculates and displays the correct line total for cart items
  based on customer type (B2B vs regular) and available discount prices.
  
  @param {object} item - The cart line item
{%- enddoc -%}

{%- liquid
  # Get the product to access metafields
  assign product = item.product
  assign variant_price = item.variant.price
  
  # Get prices from line item properties (set when adding to cart)
  assign stored_effective_price = nil
  assign addon_price_raw = nil
  
  for property in item.properties
    if property.first == '_addon_price'
      assign addon_price_raw = property.last
    elsif property.first == '_effective_price'
      assign stored_effective_price = property.last
    endif
  endfor
  
  assign addon_price = 0
  if addon_price_raw != blank
    assign addon_price = addon_price_raw | times: 100 | round
  endif
  
  # Check if user is B2B (case-insensitive, supports multiple tag variations)
  assign is_b2b_user = false
  if customer
    for tag in customer.tags
      assign tag_downcase = tag | downcase | strip
      if tag_downcase == 'b2b' or tag_downcase == 'wholesale' or tag_downcase == 'business'
        assign is_b2b_user = true
        break
      endif
    endfor
  endif
  
  # Calculate effective price - use stored price if available
  assign effective_price = variant_price
  assign show_savings = false
  
  if stored_effective_price != blank and stored_effective_price != empty
    assign effective_price = stored_effective_price | times: 100 | round
    if effective_price < variant_price
      assign show_savings = true
    endif
  else
    # Fallback: Try to get prices from metafields
    assign variant_discount_price_raw = item.variant.metafields.custom.discount_price.value
    assign product_discount_price_raw = product.metafields.custom.discount_price.value
    assign variant_b2b_price_raw = item.variant.metafields.custom.b2b_price.value
    assign product_b2b_price_raw = product.metafields.custom.b2b_price.value
    
    assign discount_price_raw = variant_discount_price_raw
    if discount_price_raw == blank or discount_price_raw == empty
      assign discount_price_raw = product_discount_price_raw
    endif
    
    assign b2b_price_raw = variant_b2b_price_raw
    if b2b_price_raw == blank or b2b_price_raw == empty
      assign b2b_price_raw = product_b2b_price_raw
    endif
    
    assign discount_price = nil
    assign b2b_price = nil
    
    if discount_price_raw != blank and discount_price_raw != empty
      assign discount_price = discount_price_raw | times: 100 | round
    endif
    
    if b2b_price_raw != blank and b2b_price_raw != empty
      assign b2b_price = b2b_price_raw | times: 100 | round
    endif
    
    if is_b2b_user
      if discount_price != nil and b2b_price != nil
        if b2b_price <= discount_price
          assign effective_price = b2b_price
        else
          assign effective_price = discount_price
        endif
        assign show_savings = true
      elsif b2b_price != nil
        assign effective_price = b2b_price
        assign show_savings = true
      elsif discount_price != nil
        assign effective_price = discount_price
        assign show_savings = true
      endif
    else
      # Standard user - use discount price if available
      if discount_price != nil
        assign effective_price = discount_price
        assign show_savings = true
      endif
    endif
  endif
  
  # Add addon price to effective price
  assign effective_price_with_addon = effective_price | plus: addon_price
  
  # Calculate totals (including addon)
  assign effective_line_price = effective_price_with_addon | times: item.quantity
  assign original_line_price = variant_price | times: item.quantity
  assign savings = original_line_price | minus: effective_line_price
  
  # Format prices
  if settings.currency_code_enabled_cart_items
    assign effective_line_formatted = effective_line_price | money_with_currency
    assign original_line_formatted = original_line_price | money_with_currency
    assign savings_formatted = savings | money_with_currency
  else
    assign effective_line_formatted = effective_line_price | money
    assign original_line_formatted = original_line_price | money
    assign savings_formatted = savings | money
  endif
-%}

<div class="cart-item-line-total">
  {% if show_savings and savings > 0 %}
    <div class="flex flex-col items-end gap-0.5">
      <s class="text-xs text-gray-400 line-through">{{ original_line_formatted }}</s>
      <span class="font-semibold text-[#CC0000]">{{ effective_line_formatted }}</span>
      <span class="text-[10px] text-green-600 font-medium">Save {{ savings_formatted }}</span>
    </div>
  {% else %}
    <text-component value="{{ effective_line_formatted | strip_html }}">{{ effective_line_formatted }}</text-component>
  {% endif %}
</div>

