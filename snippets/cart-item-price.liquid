{%- doc -%}
  Cart Item Price with B2B and Discount Logic
  
  This snippet calculates and displays the correct price for cart items
  based on customer type (B2B vs regular) and available discount prices.
  
  @param {object} item - The cart line item
{%- enddoc -%}

{%- liquid
  # Get the product to access metafields
  assign product = item.product
  assign original_price = item.original_price
  assign variant_price = item.variant.price
  
  # Get prices from line item properties (set when adding to cart)
  assign stored_effective_price = nil
  assign stored_original_price = nil
  assign stored_badge = nil
  assign addon_price_raw = nil
  
  for property in item.properties
    if property.first == '_addon_price'
      assign addon_price_raw = property.last
    elsif property.first == '_effective_price'
      assign stored_effective_price = property.last
    elsif property.first == '_original_price'
      assign stored_original_price = property.last
    elsif property.first == '_price_badge'
      assign stored_badge = property.last
    endif
  endfor
  
  assign addon_price = 0
  if addon_price_raw != blank
    assign addon_price = addon_price_raw | times: 100 | round
  endif
  
  # Check if user is B2B (case-insensitive, supports multiple tag variations)
  assign is_b2b_user = false
  if customer
    for tag in customer.tags
      assign tag_downcase = tag | downcase | strip
      if tag_downcase == 'b2b' or tag_downcase == 'wholesale' or tag_downcase == 'business'
        assign is_b2b_user = true
        break
      endif
    endfor
  endif
  
  # Initialize display variables
  assign effective_price = variant_price
  assign crossed_out_price = nil
  assign badge_text = nil
  assign badge_color = 'bg-green-600'
  assign show_crossed_price = false
  
  # Use stored prices from line item properties if available
  if stored_effective_price != blank and stored_effective_price != empty
    assign effective_price = stored_effective_price | times: 100 | round
    
    if stored_original_price != blank and stored_original_price != empty
      assign crossed_out_price = stored_original_price | times: 100 | round
      # Only show crossed price if it's different from effective price
      if crossed_out_price != effective_price
        assign show_crossed_price = true
      endif
    endif
    
    if stored_badge != blank and stored_badge != empty
      assign badge_text = stored_badge
      # Set badge color based on badge text
      if badge_text contains 'WHOLESALE'
        assign badge_color = 'bg-[#CC0000]'
      else
        assign badge_color = 'bg-green-600'
      endif
    endif
  else
    # Fallback: Try to get prices from metafields (for items added before this update)
    assign variant_discount_price_raw = item.variant.metafields.custom.discount_price.value
    assign product_discount_price_raw = product.metafields.custom.discount_price.value
    assign variant_b2b_price_raw = item.variant.metafields.custom.b2b_price.value
    assign product_b2b_price_raw = product.metafields.custom.b2b_price.value
    
    assign discount_price_raw = variant_discount_price_raw
    if discount_price_raw == blank or discount_price_raw == empty
      assign discount_price_raw = product_discount_price_raw
    endif
    
    assign b2b_price_raw = variant_b2b_price_raw
    if b2b_price_raw == blank or b2b_price_raw == empty
      assign b2b_price_raw = product_b2b_price_raw
    endif
    
    assign discount_price = nil
    assign b2b_price = nil
    
    if discount_price_raw != blank and discount_price_raw != empty
      assign discount_price = discount_price_raw | times: 100 | round
    endif
    
    if b2b_price_raw != blank and b2b_price_raw != empty
      assign b2b_price = b2b_price_raw | times: 100 | round
    endif
    
    # Calculate effective price based on user type
    if is_b2b_user
      if discount_price != nil and b2b_price != nil
        if b2b_price <= discount_price
          assign effective_price = b2b_price
          assign crossed_out_price = variant_price
          assign badge_text = 'WHOLESALE'
          assign badge_color = 'bg-[#CC0000]'
        else
          assign effective_price = discount_price
          assign crossed_out_price = variant_price
          assign badge_text = 'SPECIAL'
          assign badge_color = 'bg-green-600'
        endif
        assign show_crossed_price = true
      elsif b2b_price != nil
        assign effective_price = b2b_price
        assign crossed_out_price = variant_price
        assign badge_text = 'WHOLESALE'
        assign badge_color = 'bg-[#CC0000]'
        assign show_crossed_price = true
      elsif discount_price != nil
        assign effective_price = discount_price
        assign crossed_out_price = variant_price
        assign badge_text = 'ON SALE'
        assign show_crossed_price = true
      endif
    else
      if discount_price != nil
        assign effective_price = discount_price
        assign crossed_out_price = variant_price
        assign show_crossed_price = true
        assign price_diff = variant_price | minus: discount_price
        if variant_price > 0
          assign discount_percent = price_diff | times: 100 | divided_by: variant_price | round
        endif
        if discount_percent > 0
          assign badge_text = discount_percent | append: '% OFF'
        else
          assign badge_text = 'ON SALE'
        endif
        assign badge_color = 'bg-green-600'
      endif
    endif
  endif
  
  # Add addon price to effective price
  assign effective_price_with_addon = effective_price | plus: addon_price
  
  # Calculate line total with effective price (including addon)
  assign effective_line_price = effective_price_with_addon | times: item.quantity
  
  # Format prices
  if settings.currency_code_enabled_cart_items
    assign effective_price_formatted = effective_price | money_with_currency
    assign crossed_out_price_formatted = crossed_out_price | money_with_currency
    assign effective_line_price_formatted = effective_line_price | money_with_currency
    assign original_line_price_formatted = item.original_line_price | money_with_currency
  else
    assign effective_price_formatted = effective_price | money
    assign crossed_out_price_formatted = crossed_out_price | money
    assign effective_line_price_formatted = effective_line_price | money
    assign original_line_price_formatted = item.original_line_price | money
  endif
-%}

{%- comment -%} Unit Price Display {%- endcomment -%}
<div class="cart-item-price-display">
  {% if show_crossed_price %}
    <div class="flex flex-col items-start gap-0.5">
      <span class="text-xs text-gray-500 line-through opacity-75">
        {{ crossed_out_price_formatted }}
      </span>
      <span class="font-semibold text-[#CC0000] flex items-center gap-1.5 flex-wrap">
        {{ effective_price_formatted }}
        {% if addon_price > 0 %}
          <span class="text-xs text-blue-600">+{{ addon_price | money }}</span>
        {% endif %}
        {% if badge_text != nil %}
          <span class="text-[9px] px-1.5 py-0.5 {{ badge_color }} text-white uppercase tracking-wider font-bold" style="clip-path: polygon(0 0, 100% 0, 95% 50%, 100% 100%, 0 100%, 5% 50%);">
            {{ badge_text }}
          </span>
        {% endif %}
      </span>
    </div>
  {% else %}
    <span>{{ effective_price_formatted }}</span>
    {% if addon_price > 0 %}
      <span class="text-xs text-blue-600 ml-1">+{{ addon_price | money }}</span>
    {% endif %}
    {% if item.variant.compare_at_price > variant_price %}
      <s class="compare-at-price text-gray-500 text-xs ml-1">{{ item.variant.compare_at_price | money }}</s>
    {% endif %}
  {% endif %}
</div>

{%- comment -%} Store effective prices as data attributes for JS {%- endcomment -%}
<script type="application/json" class="cart-item-pricing-data" style="display:none;">
{
  "key": "{{ item.key }}",
  "variantId": {{ item.variant_id }},
  "originalPrice": {{ variant_price }},
  "effectivePrice": {{ effective_price }},
  "addonPrice": {{ addon_price }},
  "effectivePriceWithAddon": {{ effective_price_with_addon }},
  "effectiveLinePrice": {{ effective_line_price }},
  "quantity": {{ item.quantity }},
  "isB2B": {{ is_b2b_user }},
  "hasDiscount": {{ show_crossed_price }},
  "badge": "{{ badge_text | default: '' }}"
}
</script>

