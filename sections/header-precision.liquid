{% comment %}
  Precision Control Deck Header
  - 20% Logo | 60% Nav | 20% Utilities
  - Transparent to White on scroll
  - Redline hover effects
{% endcomment %}

<script src="{{ 'header-precision.js' | asset_url }}" defer="defer"></script>

{%- liquid
  assign header_is_transparent = false
  if template.name == 'index'
    assign header_is_transparent = true
  endif
-%}

{% if header_is_transparent %}
  <style>
    #shopify-section-{{ section.id }} {
      margin-bottom: -80px;
      position: relative;
      z-index: 1000;
    }
  </style>
{% endif %}

<header-precision class="fixed top-[36px] left-0 w-full z-[999] transition-all duration-300 group {% unless header_is_transparent %}scrolled{% endunless %}" data-transparent="{{ header_is_transparent }}">
  <!-- The Alert Line is rendered separately above this, or we can include it here if we want it part of the sticky group -->
  
  <div class="header-container h-[80px] px-4 lg:px-8 flex items-center justify-between transition-colors duration-300 bg-transparent group-[.scrolled]:bg-white group-[.scrolled]:shadow-sm">
    
    <!-- 1. Mobile Hamburger (Visible on Mobile Only) -->
    <div class="lg:hidden flex-none w-12">
      <button type="button" class="text-white group-[.scrolled]:text-[#111111] p-2" onclick="document.getElementById('mobile-menu-drawer').showModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>
    </div>

    <!-- 2. Logo (Left 20%) -->
    <div class="flex-none lg:w-[20%] flex items-center justify-center lg:justify-start">
      <a href="/" id="header-logo-link" class="text-2xl font-bold tracking-tighter uppercase transition-colors duration-300 text-white group-[.scrolled]:text-[#111111]">
        <span id="header-logo-text">{{ shop.name }}<span class="text-[#CC0000] opacity-0 group-[.scrolled]:opacity-100 transition-opacity duration-300">.</span></span>
      </a>
    </div>

    <script>
      (function() {
        const updateLogo = async () => {
          try {
            const res = await fetch('https://skm-inventory-api.miaotingshuo.workers.dev/shop/profile');
            if (!res.ok) return;
            const data = await res.json();
            
            if (data.logo && data.logo.trim() !== '') {
              // Update header logo
              const logoLink = document.getElementById('header-logo-link');
              if (logoLink) {
                const img = document.createElement('img');
                img.src = data.logo;
                img.alt = '{{ shop.name }}';
                img.style.height = '36px';
                img.style.width = 'auto';
                img.style.objectFit = 'contain';
                
                logoLink.innerHTML = '';
                logoLink.appendChild(img);
              }
              
              // Update favicon (browser tab icon)
              let favicon = document.querySelector('link[rel="icon"]') || document.querySelector('link[rel="shortcut icon"]');
              if (!favicon) {
                favicon = document.createElement('link');
                favicon.rel = 'icon';
                document.head.appendChild(favicon);
              }
              favicon.href = data.logo;
              
              // Also update apple-touch-icon if exists
              const appleTouchIcon = document.querySelector('link[rel="apple-touch-icon"]');
              if (appleTouchIcon) {
                appleTouchIcon.href = data.logo;
              }
            }
          } catch (e) {
            console.error('Logo update failed:', e);
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', updateLogo);
        } else {
          updateLogo();
        }
      })();
    </script>

    <!-- 3. Navigation (Center 60%) -->
    <nav class="max-lg:hidden flex flex-1 justify-center items-center h-full w-full">
      <ul class="flex gap-8 h-full items-center">
        {%- comment -%} Direct access fallback to 'main-menu' if section settings fail {%- endcomment -%}
        {%- assign menu_links = linklists[section.settings.menu].links -%}
        {%- if menu_links == blank -%}
          {%- assign menu_links = linklists['main-menu'].links -%}
        {%- endif -%}

        {%- for link in menu_links -%}
            <li class="h-full flex items-center group/link relative px-2">
              <a href="{{ link.url }}" class="text-[13px] font-medium uppercase tracking-[0.2em] text-white group-[.scrolled]:text-[#111111] transition-colors duration-300 block">
                {{ link.title }}
              </a>
              <span class="absolute bottom-[28px] left-0 h-[2px] bg-[#CC0000] w-0 transition-all duration-300 group-hover/link:w-full"></span>
              
              {%- if link.links != blank -%}
                <div class="absolute top-full left-0 w-screen -ml-[calc(50vw-50%)] bg-white shadow-xl opacity-0 invisible group-hover/link:opacity-100 group-hover/link:visible transition-all duration-300 border-t border-gray-100">
                  <div class="max-w-7xl mx-auto px-8 py-12 grid grid-cols-4 gap-8">
                    {%- for child_link in link.links -%}
                      <div>
                        <h4 class="font-bold text-[#111111] uppercase tracking-wider mb-4 text-sm">{{ child_link.title }}</h4>
                        <ul class="space-y-3">
                          {%- for grandchild_link in child_link.links -%}
                            <li>
                              <a href="{{ grandchild_link.url }}" class="text-gray-500 hover:text-[#CC0000] transition-colors text-sm block">{{ grandchild_link.title }}</a>
                            </li>
                          {%- endfor -%}
                        </ul>
                      </div>
                    {%- endfor -%}
                    <div class="bg-gray-50 flex items-center justify-center p-6">
                       <div class="text-center">
                          <span class="text-[#CC0000] font-bold uppercase text-xs tracking-widest mb-2 block">Featured</span>
                          <p class="text-gray-900 font-bold">Performance Series</p>
                       </div>
                    </div>
                  </div>
                </div>
              {%- endif -%}
            </li>
        {%- endfor -%}
      </ul>
    </nav>

    <!-- 4. Utilities (Right 20%) -->
    <div class="flex-none w-auto lg:w-[20%] flex items-center justify-end gap-4 lg:gap-6">
      
      <!-- Search (Lens) -->
      <button type="button" class="text-white group-[.scrolled]:text-[#111111] hover:text-[#CC0000] transition-colors" onclick="document.getElementById('search-drawer').showModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
        </svg>
      </button>

      <!-- B2B Badge -->
      {% if customer %}
        <!-- DEBUG TAGS: {{ customer.tags | join: ',' }} -->
        <script>
          console.log("Customer Tags:", {{ customer.tags | json }});
        </script>
        
        {% assign is_b2b = false %}
        {% for tag in customer.tags %}
          {% assign tag_downcase = tag | downcase | strip %}
          {% if tag_downcase == 'b2b' or tag_downcase == 'wholesale' or tag_downcase == 'business' %}
            {% assign is_b2b = true %}
            {% break %}
          {% endif %}
        {% endfor %}
        
        <!-- DEBUG IS_B2B: {{ is_b2b }} -->

        {% if is_b2b %}
          <div class="flex items-center justify-center px-3 py-1 border border-[#CC0000] bg-[#CC0000]/10 rounded-full animate-pulse hover:animate-none group cursor-default whitespace-nowrap">
            <span class="w-1.5 h-1.5 bg-[#CC0000] rounded-full mr-2"></span>
            <span class="text-[10px] font-bold uppercase tracking-widest text-[#CC0000]">BUSINESS</span>
          </div>
        {% endif %}
      {% endif %}

      <!-- Account (Driver) -->
      {% if customer %}
        <details class="relative group/user-menu">
          <summary class="list-none cursor-pointer flex items-center justify-center w-8 h-8 rounded-full bg-[#111111] text-white font-bold text-xs border border-white/20 group-[.scrolled]:border-black/10 transition-colors duration-300 hover:bg-[#CC0000] hover:border-[#CC0000] [&::-webkit-details-marker]:hidden">
            {{ customer.first_name | first }}{{ customer.last_name | first }}
          </summary>
          <div class="absolute right-0 top-full mt-2 w-48 bg-white shadow-xl border border-gray-100 rounded-sm overflow-hidden z-50 p-2">
              <div class="px-4 py-3 border-b border-gray-50 mb-2">
                  <p class="text-sm font-bold text-gray-900 truncate">{{ customer.name }}</p>
                  <p class="text-xs text-gray-500 truncate">{{ customer.email }}</p>
              </div>
              <a href="/account" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#CC0000] rounded-sm">My Profile</a>
              <a href="/account/addresses" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#CC0000] rounded-sm">Addresses</a>
              <a href="{{ routes.account_logout_url }}?return_url={{ routes.account_login_url }}?logged_out=true" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 hover:text-[#CC0000] border-t border-gray-50 mt-2 pt-2 rounded-sm">Sign out</a>
          </div>
        </details>
      {% else %}
        {% if request.design_mode %}
          <button type="button" class="block text-white group-[.scrolled]:text-[#111111] hover:text-[#CC0000] transition-colors relative group/account">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
            <span class="absolute top-full right-0 mt-2 bg-black text-white text-[10px] uppercase font-bold px-2 py-1 opacity-0 group-hover/account:opacity-100 transition-opacity whitespace-nowrap hidden lg:block">
              Login disabled in editor
            </span>
          </button>
        {% else %}
          <a href="/account/login" class="block text-white group-[.scrolled]:text-[#111111] hover:text-[#CC0000] transition-colors relative group/account">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
            <span class="absolute top-full right-0 mt-2 bg-black text-white text-[10px] uppercase font-bold px-2 py-1 opacity-0 group-hover/account:opacity-100 transition-opacity whitespace-nowrap hidden lg:block">
              Login / Join
            </span>
          </a>
        {% endif %}
      {% endif %}

      <!-- Cart (Payload) -->
      <a href="{{ routes.cart_url }}" class="text-white group-[.scrolled]:text-[#111111] hover:text-[#CC0000] transition-colors relative" id="cart-icon-bubble">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119 1.007zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
        </svg>
        <span 
          id="precision-cart-count" 
          class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-[#CC0000] text-[9px] font-bold text-white transition-transform duration-200 {% if cart.item_count == 0 %}hidden{% endif %}"
          data-cart-count="{{ cart.item_count }}"
        >
          {{ cart.item_count }}
        </span>
      </a>

    </div>
  </div>
</header-precision>

<!-- Category Navigation Bar -->
<nav id="category-nav" class="fixed top-[116px] left-0 w-full z-[998] bg-[#1a1a1a] border-b border-[#333]">
  <div class="max-w-[1920px] mx-auto px-4 lg:px-8">
    <div class="flex items-center justify-center gap-2 h-10 overflow-x-auto scrollbar-hide">
      <div id="category-links" class="flex items-center gap-1 lg:gap-2">
        <span class="text-[10px] text-gray-500 uppercase tracking-wider">Loading...</span>
      </div>
    </div>
  </div>
</nav>

<script>
(function() {
  const loadCategories = async () => {
    try {
      const res = await fetch('https://skm-inventory-api.miaotingshuo.workers.dev/categories');
      if (!res.ok) return;
      const data = await res.json();
      
      const container = document.getElementById('category-links');
      if (!container || !data.data || data.data.length === 0) {
        container.innerHTML = '<a href="/collections/all" class="category-link">All Products</a>';
        return;
      }
      
      // Build category links - use type query for products
      let html = '<a href="/collections/all" class="category-link active">All</a>';
      data.data.forEach(cat => {
        // Use Shopify's product type filter in URL
        const filterUrl = `/collections/all?filter.p.product_type=${encodeURIComponent(cat.name)}`;
        html += `<a href="${filterUrl}" class="category-link" data-type="${cat.name}">${cat.name} <span class="text-[9px] opacity-60">(${cat.count})</span></a>`;
      });
      
      container.innerHTML = html;
      
      // Highlight active category based on current URL
      const urlParams = new URLSearchParams(window.location.search);
      const activeType = urlParams.get('filter.p.product_type');
      if (activeType) {
        container.querySelectorAll('.category-link').forEach(link => {
          link.classList.remove('active');
          if (link.dataset.type === activeType) {
            link.classList.add('active');
          }
        });
      }
    } catch (e) {
      console.error('Failed to load categories:', e);
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadCategories);
  } else {
    loadCategories();
  }
})();
</script>

<style>
  #category-nav {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  #category-nav::-webkit-scrollbar {
    display: none;
  }
  .category-link {
    display: inline-block;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.6);
    white-space: nowrap;
    transition: all 0.2s;
    border-radius: 4px;
  }
  .category-link:hover {
    color: white;
    background: rgba(204, 0, 0, 0.2);
  }
  .category-link.active {
    color: #CC0000;
    background: rgba(204, 0, 0, 0.1);
  }
  @media (max-width: 1024px) {
    .category-link {
      padding: 4px 8px;
      font-size: 10px;
    }
  }
</style>

<!-- Mobile Menu Drawer -->
<dialog id="mobile-menu-drawer" class="fixed inset-y-0 left-0 z-[1000] w-[85vw] max-w-[400px] h-[100dvh] max-h-[100dvh] bg-white p-0 m-0 border-r border-gray-100 shadow-2xl backdrop:bg-black/60 backdrop:backdrop-blur-sm open:animate-slide-in-left outline-none">
  <div class="flex flex-col h-full bg-white">
    <!-- Header -->
    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
      <span class="text-xl font-bold uppercase tracking-tighter">{{ shop.name }}</span>
      <button onclick="document.getElementById('mobile-menu-drawer').close()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors group">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500 group-hover:text-[#CC0000]">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto overflow-x-hidden p-0 bg-white">
      <nav class="py-4">
        <ul class="flex flex-col">
          {%- for link in section.settings.menu.links -%}
            <li class="border-b border-gray-50 last:border-none">
              {%- if link.links != blank -%}
                <details class="group/dropdown">
                  <summary class="flex items-center justify-between w-full px-8 py-5 text-left cursor-pointer list-none [&::-webkit-details-marker]:hidden">
                    <span class="text-lg font-bold text-[#111111] uppercase tracking-wide group-hover/dropdown:text-[#CC0000] transition-colors">{{ link.title }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 group-open/dropdown:rotate-180 transition-transform duration-300">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                  </summary>
                  <div class="bg-gray-50 px-8 py-4 space-y-4">
                    {%- for child_link in link.links -%}
                      <div>
                        <a href="{{ child_link.url }}" class="block text-sm font-bold text-[#111111] uppercase tracking-wider mb-2">{{ child_link.title }}</a>
                        {%- if child_link.links != blank -%}
                          <ul class="pl-4 space-y-2 border-l border-gray-200">
                            {%- for grandchild_link in child_link.links -%}
                              <li>
                                <a href="{{ grandchild_link.url }}" class="block text-sm text-gray-500 hover:text-[#CC0000]">{{ grandchild_link.title }}</a>
                              </li>
                            {%- endfor -%}
                          </ul>
                        {%- endif -%}
                      </div>
                    {%- endfor -%}
                  </div>
                </details>
              {%- else -%}
                <a href="{{ link.url }}" class="block w-full px-8 py-5 text-lg font-bold text-[#111111] uppercase tracking-wide hover:text-[#CC0000] hover:bg-gray-50 transition-colors">
                  {{ link.title }}
                </a>
              {%- endif -%}
            </li>
          {%- endfor -%}
        </ul>
      </nav>
    </div>

    <!-- Footer Actions -->
    <div class="p-6 border-t border-gray-100 bg-white space-y-4">
      {% if request.design_mode %}
        <button type="button" class="flex items-center justify-center w-full h-14 bg-[#111111] text-white font-bold uppercase tracking-widest hover:bg-[#CC0000] transition-colors shadow-lg">
          {% if customer %}My Garage{% else %}Login disabled{% endif %}
        </button>
      {% else %}
        {% if customer %}
          <a href="/account" class="flex items-center justify-center w-full h-14 bg-[#111111] text-white font-bold uppercase tracking-widest hover:bg-[#CC0000] transition-colors shadow-lg mb-3">
            My Garage
          </a>
          <a href="{{ routes.account_logout_url }}?return_url={{ routes.account_login_url }}?logged_out=true" class="flex items-center justify-center w-full h-12 border border-gray-200 text-gray-500 font-bold uppercase tracking-widest hover:text-[#111111] hover:border-[#111111] transition-colors">
            Sign Out
          </a>
        {% else %}
          <a href="/account/login" class="flex items-center justify-center w-full h-14 bg-[#CC0000] text-white font-bold uppercase tracking-widest hover:bg-red-700 transition-colors shadow-lg">
            Login / Register
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
</dialog>

<!-- Search Drawer -->
<dialog id="search-drawer" class="fixed inset-0 w-[100vw] bg-transparent z-[1000] p-0 m-0 backdrop:bg-black/60 open:animate-slide-down overflow-hidden">
  <div class="fixed top-0 left-0 right-0 w-[100vw] bg-white px-0 py-6 shadow-md">
     <div class="w-[100vw] box-border flex items-center justify-between gap-4 border-b-2 border-gray-200 focus-within:border-[#CC0000] transition-colors pb-4">
       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-400">
         <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
       </svg>
       <predictive-search class="flex-1">
          <form action="{{ routes.search_url }}" method="get" role="search">
             <input 
               id="Search-In-Modal"
               type="search"
               name="q"
               value=""
               placeholder="SEARCH PARTS (e.g. Mustang GT Exhaust)"
               class="w-full text-2xl font-bold uppercase tracking-wide placeholder-gray-300 outline-none text-[#111111]"
               role="combobox"
               aria-expanded="false"
               aria-owns="predictive-search-results"
               aria-controls="predictive-search-results"
               aria-haspopup="listbox"
               aria-autocomplete="list"
            >
            <input name="options[prefix]" type="hidden" value="last">
            <div id="predictive-search" tabindex="-1"></div>
          </form>
       </predictive-search>
       <button onclick="document.getElementById('search-drawer').close()" class="text-gray-400 hover:text-[#CC0000]">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
     </div>
  </div>
</dialog>

{% schema %}
{
  "name": "Precision Control Deck",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    }
  ],
  "presets": [
    {
      "name": "Precision Control Deck"
    }
  ]
}
{% endschema %}
