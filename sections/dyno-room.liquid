<!-- =========================================
     THE SONIC LABORATORY: Audio Analysis Dashboard
     Acoustic waveform visualization with RPM stages
========================================== -->

<div class="bg-[#0a0a0a] text-white py-0">
  <div class="flex flex-col lg:flex-row min-h-[700px]">
    
    <!-- Left: Audio Visualizer -->
    <div class="w-full lg:w-1/2 relative flex items-center justify-center p-8 lg:p-16 border-b lg:border-b-0 lg:border-r border-white/5">
      
      <!-- Background Grid -->
      <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 25px 25px;"></div>
      
      <!-- Waveform Visualizer Container -->
      <div class="relative w-full max-w-lg z-10">
        
        <!-- Visualizer Title -->
        <div class="hud-spec-label mb-6 text-center">[ ACOUSTIC_SPECTROGRAM ]</div>
        
        <!-- Audio Waveform Display -->
        <div id="sonic-visualizer-{{ section.id }}" class="relative h-48 bg-black/50 border border-white/10 overflow-hidden rounded-sm">
          <!-- Waveform bars (CSS animated) -->
          <div class="flex items-end justify-center gap-1 h-full p-4" id="waveform-bars-{{ section.id }}">
            {%- for i in (1..32) -%}
              <div class="waveform-bar w-2 bg-gradient-to-t from-[#CC0000] to-[#ff4444] rounded-t-sm transition-all duration-100" 
                   style="height: {{ i | modulo: 8 | times: 10 | plus: 20 }}%; animation-delay: {{ i | times: 50 }}ms;"></div>
            {%- endfor -%}
          </div>
          
          <!-- Scanning Line -->
          <div class="absolute top-0 left-0 w-[2px] h-full bg-[#CC0000] opacity-50 animate-scan"></div>
          
          <!-- Grid Overlay -->
          <div class="absolute inset-0 pointer-events-none" style="background-image: linear-gradient(transparent 49%, rgba(204,0,0,0.1) 50%, transparent 51%); background-size: 100% 20px;"></div>
        </div>
        
        <!-- RPM Stage Toggles -->
        <div class="flex justify-center gap-2 mt-6">
          <button class="rpm-toggle hud-mono text-xs px-4 py-2 border border-white/20 hover:border-[#CC0000] hover:text-[#CC0000] transition-colors active" data-rpm="idle">
            IDLE
          </button>
          <button class="rpm-toggle hud-mono text-xs px-4 py-2 border border-white/20 hover:border-[#CC0000] hover:text-[#CC0000] transition-colors" data-rpm="3000">
            3000_RPM
          </button>
          <button class="rpm-toggle hud-mono text-xs px-4 py-2 border border-white/20 hover:border-[#CC0000] hover:text-[#CC0000] transition-colors" data-rpm="redline">
            REDLINE
          </button>
        </div>
        
        <!-- Play Controls -->
        <div class="flex justify-center mt-8">
          <button id="play-audio-{{ section.id }}" 
                  class="w-20 h-20 rounded-full bg-[#CC0000] flex items-center justify-center shadow-[0_0_40px_rgba(204,0,0,0.4)] hover:scale-110 transition-transform duration-300"
                  onclick="toggleAudio('{{ section.id }}')">
            <svg id="play-icon-{{ section.id }}" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" class="w-8 h-8 ml-1">
              <path d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
            </svg>
            <svg id="pause-icon-{{ section.id }}" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" class="w-8 h-8 hidden">
              <path d="M6 4h4v16H6zM14 4h4v16h-4z" />
            </svg>
          </button>
        </div>
        
        <p class="hud-mono text-xs text-gray-500 text-center mt-4" id="audio-status-text-{{ section.id }}">CLICK TO INITIALIZE AUDIO SEQUENCE</p>
      </div>
    </div>
    
    <!-- Right: Metrics Dashboard -->
    <div class="w-full lg:w-1/2 p-8 lg:p-16 flex flex-col justify-center">
      
      <!-- Section Header -->
      <div class="mb-12">
        <div class="hud-spec-label mb-3">[ EMPIRICAL_VALIDATION ]</div>
        <h2 class="text-4xl md:text-5xl font-bold tracking-tight mb-4" style="font-family: 'Helvetica Now Display', Inter, sans-serif;">
          {{ section.settings.heading | default: "THE SONIC LABORATORY" }}
        </h2>
        <p class="text-gray-400 hud-mono text-sm max-w-md">
          Real-time acoustic analysis demonstrating measurable performance improvements.
        </p>
      </div>
      
      <!-- Metrics Grid -->
      <div class="grid grid-cols-2 gap-8 mb-12">
        {%- for block in section.blocks -%}
          <div class="metric-card p-6 border border-white/10 bg-white/[0.02] hover:bg-white/[0.05] transition-colors">
            <div class="hud-spec-label mb-2">[ {{ block.settings.label | upcase | replace: ' ', '_' }} ]</div>
            <div class="text-4xl md:text-5xl font-mono font-bold text-[#CC0000] mb-2" data-metric="{{ block.settings.value }}">
              {{ block.settings.value }}
            </div>
            <div class="text-gray-500 text-sm">{{ block.settings.label }}</div>
          </div>
        {%- endfor -%}
      </div>
      
      <!-- dB Meter -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <span class="hud-mono text-xs text-gray-500">DECIBEL_OUTPUT</span>
          <span id="db-value-{{ section.id }}" class="hud-mono text-sm text-[#CC0000]">0 dB</span>
        </div>
        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
          <div id="db-meter-{{ section.id }}" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-[#CC0000] w-0 transition-all duration-100 rounded-full"></div>
        </div>
        <div class="flex justify-between mt-1 hud-mono text-[10px] text-gray-600">
          <span>0</span>
          <span>60</span>
          <span>90</span>
          <span>120 dB</span>
        </div>
      </div>
      
      <!-- Horsepower Graph -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="hud-mono text-xs text-gray-500">HORSEPOWER_GAIN</span>
          <span id="hp-value-{{ section.id }}" class="hud-mono text-sm text-green-500">+0 HP</span>
        </div>
        <div class="h-16 bg-white/5 rounded-sm relative overflow-hidden" id="hp-graph-{{ section.id }}">
          <!-- Graph will be drawn via JS -->
          <svg class="w-full h-full">
            <path id="hp-path-{{ section.id }}" d="M0 60" stroke="#CC0000" stroke-width="2" fill="none" class="transition-all duration-500"></path>
            <path id="hp-area-{{ section.id }}" d="M0 60" stroke="none" fill="url(#hp-gradient-{{ section.id }})" opacity="0.3"></path>
            <defs>
              <linearGradient id="hp-gradient-{{ section.id }}" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#CC0000;stop-opacity:0.5" />
                <stop offset="100%" style="stop-color:#CC0000;stop-opacity:0" />
              </linearGradient>
            </defs>
          </svg>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Audio Element -->
<audio id="audio-player-{{ section.id }}" src="{{ section.settings.audio_idle | default: section.settings.audio_url }}" preload="metadata"></audio>

<!-- Sonic Laboratory Script -->
<script>
(function() {
  const sectionId = '{{ section.id }}';
  let isPlaying = false;
  let animationInterval;
  let currentRpm = 'idle';
  
  // Audio Sources Map
  const audioSources = {
    'idle': "{{ section.settings.audio_idle | default: section.settings.audio_url }}",
    '3000': "{{ section.settings.audio_3000 | default: section.settings.audio_url }}",
    'redline': "{{ section.settings.audio_redline | default: section.settings.audio_url }}"
  };
  
  // Toggle audio playback
  window.toggleAudio = function(id) {
    const playIcon = document.getElementById('play-icon-' + id);
    const pauseIcon = document.getElementById('pause-icon-' + id);
    const audioPlayer = document.getElementById('audio-player-' + id);
    const statusText = document.getElementById('audio-status-text-' + id);
    
    isPlaying = !isPlaying;
    
    if (isPlaying) {
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
      if (audioPlayer) {
        // Ensure source is set correctly before playing (just in case)
        if (!audioPlayer.src || audioPlayer.src !== audioSources[currentRpm]) {
            audioPlayer.src = audioSources[currentRpm];
        }
        audioPlayer.play().catch(e => {
            console.error("Audio play failed:", e);
            statusText.textContent = "AUDIO ERROR - CHECK CONSOLE";
            isPlaying = false;
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
        });
      }
      startVisualization(id);
      if (statusText) statusText.textContent = "PLAYING SEQUENCE: " + currentRpm.toUpperCase();
    } else {
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      if (audioPlayer) audioPlayer.pause();
      stopVisualization(id);
      if (statusText) statusText.textContent = "SEQUENCE PAUSED";
    }
  };
  
  // Waveform animation
  function startVisualization(id) {
    const bars = document.querySelectorAll('#waveform-bars-' + id + ' .waveform-bar');
    const dbMeter = document.getElementById('db-meter-' + id);
    const dbValue = document.getElementById('db-value-' + id);
    const hpValue = document.getElementById('hp-value-' + id);
    
    // Intensity multiplier based on RPM
    let intensity = 1;
    if (currentRpm === '3000') intensity = 1.2;
    if (currentRpm === 'redline') intensity = 1.5;

    animationInterval = setInterval(() => {
      // Animate bars
      bars.forEach(bar => {
        const height = (Math.random() * 80 + 20) * intensity;
        bar.style.height = Math.min(height, 100) + '%';
      });
      
      // Update dB meter
      const baseDb = currentRpm === 'idle' ? 85 : (currentRpm === '3000' ? 95 : 105);
      const randomVar = Math.random() * 5;
      const db = Math.floor(baseDb + randomVar);
      
      if (dbMeter) dbMeter.style.width = Math.min((db / 120 * 100), 100) + '%';
      if (dbValue) dbValue.textContent = db + ' dB';
      
      // Update HP
      // Keep static HP display usually, or animate slightly? Let's just animate slightly
      // const hp = Math.floor(Math.random() * 10 + 20);
      // if (hpValue) hpValue.textContent = '+' + hp + ' HP';
      
    }, 100);
  }
  
  function stopVisualization(id) {
    clearInterval(animationInterval);
    
    const bars = document.querySelectorAll('#waveform-bars-' + id + ' .waveform-bar');
    bars.forEach((bar, i) => {
      bar.style.height = (i % 8 * 10 + 20) + '%';
    });
    
    const dbMeter = document.getElementById('db-meter-' + id);
    const dbValue = document.getElementById('db-value-' + id);
   // const hpValue = document.getElementById('hp-value-' + id);
    
    if (dbMeter) dbMeter.style.width = '0%';
    if (dbValue) dbValue.textContent = '0 dB';
    // if (hpValue) hpValue.textContent = '+0 HP';
  }
  
  // RPM toggle logic
  document.querySelectorAll('.rpm-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
      const sectionId = '{{ section.id }}';
      const newRpm = this.getAttribute('data-rpm');
      
      // Update UI
      document.querySelectorAll('.rpm-toggle').forEach(b => b.classList.remove('active', 'border-[#CC0000]', 'text-[#CC0000]'));
      this.classList.add('active', 'border-[#CC0000]', 'text-[#CC0000]');
      
      currentRpm = newRpm;
      
      // Switch Audio Source
      const audioPlayer = document.getElementById('audio-player-' + sectionId);
      const statusText = document.getElementById('audio-status-text-' + sectionId);
      
      if (audioPlayer) {
          const wasPlaying = !audioPlayer.paused;
          audioPlayer.src = audioSources[newRpm];
          
          if (wasPlaying) {
              audioPlayer.play();
              if (statusText) statusText.textContent = "PLAYING SEQUENCE: " + currentRpm.toUpperCase();
          } else {
             if (statusText) statusText.textContent = "SEQUENCE READY: " + currentRpm.toUpperCase();
          }
      }
    });
  });
})();
</script>

<style>
  .waveform-bar {
    animation: waveform 0.5s ease-in-out infinite alternate;
  }
  
  @keyframes waveform {
    0% { transform: scaleY(0.5); }
    100% { transform: scaleY(1); }
  }
  
  @keyframes scan {
    0% { left: 0; }
    100% { left: 100%; }
  }
  
  .animate-scan {
    animation: scan 3s linear infinite;
  }
  
  .rpm-toggle.active {
    border-color: #CC0000;
    color: #CC0000;
  }
</style>

{% schema %}
{
  "name": "Sonic Laboratory",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "THE SONIC LABORATORY"
    },
    {
      "type": "header",
      "content": "Audio Configuration"
    },
    {
      "type": "url",
      "id": "audio_idle",
      "label": "Audio: Idle (MP3)",
      "info": "Audio track for Idle state"
    },
    {
      "type": "url",
      "id": "audio_3000",
      "label": "Audio: 3000 RPM (MP3)",
      "info": "Audio track for 3000 RPM state"
    },
    {
      "type": "url",
      "id": "audio_redline",
      "label": "Audio: Redline (MP3)",
      "info": "Audio track for Redline state"
    },
    {
      "type": "url",
      "id": "audio_url",
      "label": "Legacy Audio (Fallback)",
      "info": "Used if specific tracks above are not set."
    }
  ],
  "blocks": [
    {
      "type": "spec",
      "name": "Metric",
      "settings": [
        {
          "type": "text",
          "id": "value",
          "label": "Value",
          "default": "110dB"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Raw Output"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Sonic Laboratory",
      "blocks": [
        {
          "type": "spec",
          "settings": {
            "value": "110dB",
            "label": "Peak Output"
          }
        },
        {
          "type": "spec",
          "settings": {
            "value": "+25 HP",
            "label": "Dyno Verified Gain"
          }
        }
      ]
    }
  ]
}
{% endschema %}
