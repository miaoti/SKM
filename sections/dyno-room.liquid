<!-- =========================================
     THE SONIC LABORATORY: Audio Analysis Dashboard
     Acoustic waveform visualization with RPM stages
========================================== -->

<div class="bg-[#0a0a0a] text-white py-0">
  <div class="flex flex-col xl:flex-row min-h-[600px] xl:min-h-[700px]">
    
    <!-- Left: Audio Visualizer -->
    <div class="w-full xl:w-1/2 relative flex items-center justify-center p-6 md:p-8 xl:p-12 border-b xl:border-b-0 xl:border-r border-white/5">
      
      <!-- Background Grid -->
      <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 25px 25px;"></div>
      
      <!-- Waveform Visualizer Container -->
      <div class="relative w-full max-w-lg z-10">
        
        <!-- Visualizer Title -->
        <div class="hud-spec-label mb-6 text-center">[ ACOUSTIC_SPECTROGRAM ]</div>
        
        <!-- Audio Waveform Display -->
        <div id="sonic-visualizer-{{ section.id }}" class="relative h-48 bg-black/50 border border-white/10 overflow-hidden rounded-sm">
          <!-- Waveform bars -->
          <div class="flex items-end justify-center gap-1 h-full p-4" id="waveform-bars-{{ section.id }}">
            {%- for i in (1..32) -%}
              <!-- Initial static height for "ready" state -->
              <div class="waveform-bar w-2 bg-gradient-to-t from-[#CC0000] to-[#ff4444] rounded-t-sm transition-[height] duration-75" 
                   style="height: 10%;"></div>
            {%- endfor -%}
          </div>
          
          <!-- Scanning Line -->
          <div class="absolute top-0 left-0 w-[2px] h-full bg-[#CC0000] opacity-50 animate-scan"></div>
          
          <!-- Grid Overlay -->
          <div class="absolute inset-0 pointer-events-none" style="background-image: linear-gradient(transparent 49%, rgba(204,0,0,0.1) 50%, transparent 51%); background-size: 100% 20px;"></div>
        </div>
        
        <!-- RPM Stage Toggles -->
        <div class="flex justify-center gap-2 mt-6">
          <button class="rpm-toggle hud-mono text-xs px-4 py-2 border border-white/20 hover:border-[#CC0000] hover:text-[#CC0000] transition-colors active" data-rpm="idle">
            IDLE
          </button>
          <button class="rpm-toggle hud-mono text-xs px-4 py-2 border border-white/20 hover:border-[#CC0000] hover:text-[#CC0000] transition-colors" data-rpm="3000">
            3000_RPM
          </button>
          <button class="rpm-toggle hud-mono text-xs px-4 py-2 border border-white/20 hover:border-[#CC0000] hover:text-[#CC0000] transition-colors" data-rpm="redline">
            REDLINE
          </button>
        </div>
        
        <!-- Play Controls -->
        <div class="flex justify-center mt-8">
          <button id="play-audio-{{ section.id }}" 
                  class="w-20 h-20 rounded-full bg-[#CC0000] flex items-center justify-center shadow-[0_0_40px_rgba(204,0,0,0.4)] hover:scale-110 transition-transform duration-300"
                  onclick="toggleAudio('{{ section.id }}')">
            <svg id="play-icon-{{ section.id }}" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" class="w-8 h-8 ml-1">
              <path d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
            </svg>
            <svg id="pause-icon-{{ section.id }}" xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" class="w-8 h-8 hidden">
              <path d="M6 4h4v16H6zM14 4h4v16h-4z" />
            </svg>
          </button>
        </div>
        
        <p class="hud-mono text-xs text-gray-500 text-center mt-4" id="audio-status-text-{{ section.id }}">CLICK TO INITIALIZE AUDIO SEQUENCE</p>
      </div>
    </div>
    
    <!-- Right: Metrics Dashboard -->
    <div class="w-full xl:w-1/2 p-6 md:p-8 xl:p-12 flex flex-col justify-center items-stretch">
      
      <!-- Section Header -->
      <div class="mb-6 md:mb-10">
        <div class="hud-spec-label mb-3">[ EMPIRICAL_VALIDATION ]</div>
        <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight mb-4" style="font-family: 'Helvetica Now Display', Inter, sans-serif;">
          {{ section.settings.heading | default: "THE SONIC LABORATORY" }}
        </h2>
        <p class="text-gray-400 hud-mono text-sm">
          Real-time acoustic analysis demonstrating measurable performance improvements.
        </p>
      </div>
      
      <!-- Metrics - Full Width Flex Layout -->
      <div class="flex flex-col sm:flex-row gap-4 md:gap-6 mb-8 md:mb-10 w-full">
        {%- for block in section.blocks -%}
          <div class="metric-card flex-1 p-5 sm:p-6 md:p-8 border border-white/10 bg-white/[0.02] hover:bg-white/[0.05] transition-colors">
            <div class="hud-spec-label mb-2 text-[10px] sm:text-xs">[ {{ block.settings.label | upcase | replace: ' ', '_' }} ]</div>
            <div class="text-3xl sm:text-4xl md:text-5xl font-mono font-bold text-[#CC0000] mb-2" data-metric="{{ block.settings.value }}">
              {{ block.settings.value }}
            </div>
            <div class="text-gray-500 text-xs sm:text-sm">{{ block.settings.label }}</div>
          </div>
        {%- endfor -%}
      </div>
      
      <!-- dB Meter - Full Width -->
      <div class="w-full">
        <div class="flex items-center justify-between mb-2">
          <span class="hud-mono text-xs text-gray-500 db-label-text">DECIBEL_OUTPUT</span>
          <span id="db-value-{{ section.id }}" class="hud-mono text-sm text-[#CC0000]">0 dB</span>
        </div>
        <div class="h-2 bg-white/10 rounded-full overflow-hidden">
          <div id="db-meter-{{ section.id }}" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-[#CC0000] w-0 transition-all duration-75 rounded-full"></div>
        </div>
        <div class="flex justify-between mt-1 hud-mono text-[10px] text-gray-600">
          <span>0</span>
          <span>60</span>
          <span>90</span>
          <span>120 dB</span>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- Audio Element with crossorigin for Web Audio API -->
<audio id="audio-player-{{ section.id }}" crossorigin="anonymous" src="{{ section.settings.audio_idle | default: section.settings.audio_url }}" preload="metadata"></audio>

<!-- Sonic Laboratory Script -->
<script>
(function() {
  const sectionId = '{{ section.id }}';
  let isPlaying = false;
  let currentRpm = 'idle';
  
  // Real-time Audio Context Vars
  let audioContext = null;
  let analyser = null;
  let source = null;
  let animationFrameId = null;
  let isFallbackMode = false;
  
  // Audio Sources Map - Raw Settings
  const rawSources = {
    'idle': "{{ section.settings.audio_idle | default: section.settings.audio_url }}",
    '3000': "{{ section.settings.audio_3000 | default: section.settings.audio_url }}",
    'redline': "{{ section.settings.audio_redline | default: section.settings.audio_url }}"
  };

  // Helper: fix GitHub Raw URLs to ensure CORS works
  // github.com/.../raw/... -> raw.githubusercontent.com/...
  function getProxiedUrl(url) {
    if (!url) return '';
    // Handle "github.com/USER/REPO/raw/refs/heads/BRANCH/PATH"
    if (url.includes('github.com') && url.includes('/raw/')) {
        return url.replace(
            /https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/raw\/refs\/heads\/([^\/]+)\/(.+)/, 
            'https://raw.githubusercontent.com/$1/$2/$3/$4'
        ).replace(
            /https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/raw\/([^\/]+)\/(.+)/,
            'https://raw.githubusercontent.com/$1/$2/$3/$4'
        );
    }
    return url;
  }
  
  // Final processed sources
  const audioSources = {
      'idle': getProxiedUrl(rawSources['idle']),
      '3000': getProxiedUrl(rawSources['3000']),
      'redline': getProxiedUrl(rawSources['redline'])
  };
  
  // Initialize Web Audio API
  function initAudioContext() {
    if (audioContext || isFallbackMode) return; 
    
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        
        const audioPlayer = document.getElementById('audio-player-' + sectionId);
        if (!audioPlayer) return;
        
        // Create Analyser
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 64; 
        
        // Connect Audio Node -> Analyser -> Destination
        if (!source) {
            source = audioContext.createMediaElementSource(audioPlayer);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
        }
    } catch (e) {
        console.warn("Web Audio API failed, enabling fallback:", e);
        enableFallbackMode();
    }
  }

  function enableFallbackMode() {
      if (isFallbackMode) return;
      isFallbackMode = true;
      console.log("Enabling audio fallback mode (Visualizer simulated)");
      
      const audioPlayer = document.getElementById('audio-player-' + sectionId);
      if (audioPlayer) {
          // Remove crossorigin to allow non-CORS playback
          audioPlayer.removeAttribute('crossorigin');
          // Reload src to apply attribute change
          const currentSrc = audioPlayer.src;
          audioPlayer.src = '';
          audioPlayer.src = currentSrc; 
      }
  }
  
  // Toggle audio playback
  window.toggleAudio = function(id) {
    const playIcon = document.getElementById('play-icon-' + id);
    const pauseIcon = document.getElementById('pause-icon-' + id);
    const audioPlayer = document.getElementById('audio-player-' + id);
    const statusText = document.getElementById('audio-status-text-' + id);
    
    // Attempt init content if not fallback
    if (!isFallbackMode && !audioContext) {
      initAudioContext();
    }
    
    // Resume context if suspended
    if (audioContext && audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    isPlaying = !isPlaying;
    
    if (isPlaying) {
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
      if (audioPlayer) {
        // Switch source if needed
        if (!audioPlayer.src || audioPlayer.src !== audioSources[currentRpm]) {
            audioPlayer.src = audioSources[currentRpm];
        }
        
        const playPromise = audioPlayer.play();
        if (playPromise) {
            playPromise.then(() => {
                if (!isFallbackMode) {
                    drawVisualization();
                } else {
                    simulateVisualization();
                }
            }).catch(e => {
                console.error("Audio play error:", e);
                // If error is DOMException (CORS), enable fallback and retry
                if ((e.name === 'NotSupportedError' || e.message.includes('media'))) {
                     enableFallbackMode();
                     audioPlayer.play().then(() => simulateVisualization()).catch(err => {
                         statusText.textContent = "PLAYBACK FAILED";
                         onPause(id);
                     });
                } else {
                    statusText.textContent = "AUDIO ERROR";
                    onPause(id);
                }
            });
        }
      }
      if (statusText) statusText.textContent = "PLAYING: " + currentRpm.toUpperCase();
    } else {
      onPause(id);
      if (audioPlayer) audioPlayer.pause();
      if (statusText) statusText.textContent = "PAUSED";
    }
  };
  
  function onPause(id) {
      const playIcon = document.getElementById('play-icon-' + id);
      const pauseIcon = document.getElementById('pause-icon-' + id);
      isPlaying = false;
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      cancelAnimationFrame(animationFrameId);
      resetVisualizer(id);
  }

  // Real-time Visualization Loop
  function drawVisualization() {
    if (isFallbackMode) return;
    
    const bars = document.querySelectorAll('#waveform-bars-' + sectionId + ' .waveform-bar');
    const dbMeter = document.getElementById('db-meter-' + sectionId);
    const dbValue = document.getElementById('db-value-' + sectionId);
    
    if (!analyser) return;
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);
    
    bars.forEach((bar, index) => {
      const dataIndex = index < bufferLength ? index : bufferLength - 1;
      const value = dataArray[dataIndex];
      const heightPercent = (value / 255) * 100;
      bar.style.height = Math.max(heightPercent, 10) + '%';
    });
    
    let sum = 0;
    for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
    const average = sum / bufferLength;
    
    let calibratedDb = 0;
    if (average > 0) calibratedDb = Math.floor(60 + (average / 255) * 60);
    
    if (dbMeter) dbMeter.style.width = Math.min((calibratedDb / 120 * 100), 100) + '%';
    if (dbValue) dbValue.textContent = calibratedDb + ' dB';
    
    animationFrameId = requestAnimationFrame(drawVisualization);
  }
  
  // Fallback Simulation
  function simulateVisualization() {
      const bars = document.querySelectorAll('#waveform-bars-' + sectionId + ' .waveform-bar');
      const dbMeter = document.getElementById('db-meter-' + sectionId);
      const dbValue = document.getElementById('db-value-' + sectionId);
      const specLabel = document.querySelector('#sonic-visualizer-' + sectionId + ' .hud-spec-label');
      
      // Update label to indicate simulation
      const dbLabel = document.querySelector('.db-label-text');
      if (dbLabel) dbLabel.textContent = "DECIBEL_OUTPUT (SIMULATED)";
      
      let intensity = 1;
      let baseDb = 85;
      if (currentRpm === '3000') { intensity = 1.3; baseDb = 95; }
      if (currentRpm === 'redline') { intensity = 1.6; baseDb = 105; }
      
      function loop() {
          if (!isPlaying) return;
          bars.forEach(bar => {
              const h = (Math.random() * 80 + 10) * intensity;
              bar.style.height = Math.min(h, 100) + '%';
          });
          const db = Math.floor(baseDb + Math.random() * 5);
          if (dbMeter) dbMeter.style.width = Math.min((db / 110 * 100), 100) + '%';
          if (dbValue) dbValue.textContent = db + ' dB';
          
          setTimeout(() => {
              if (isPlaying) animationFrameId = requestAnimationFrame(loop);
          }, 80);
      }
      loop();
  }
  
  function resetVisualizer(id) {
    const bars = document.querySelectorAll('#waveform-bars-' + id + ' .waveform-bar');
    const dbMeter = document.getElementById('db-meter-' + id);
    const dbValue = document.getElementById('db-value-' + id);
    const dbLabel = document.querySelector('.db-label-text');
    
    bars.forEach(bar => { bar.style.height = '10%'; });
    
    if (dbMeter) dbMeter.style.width = '0%';
    if (dbValue) dbValue.textContent = '0 dB';
    if (dbLabel) dbLabel.textContent = "DECIBEL_OUTPUT";
  }
  
  // RPM toggle logic
  document.querySelectorAll('.rpm-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
      const sectionId = '{{ section.id }}';
      const newRpm = this.getAttribute('data-rpm');
      
      document.querySelectorAll('.rpm-toggle').forEach(b => b.classList.remove('active', 'border-[#CC0000]', 'text-[#CC0000]'));
      this.classList.add('active', 'border-[#CC0000]', 'text-[#CC0000]');
      
      currentRpm = newRpm;
      
      const audioPlayer = document.getElementById('audio-player-' + sectionId);
      const statusText = document.getElementById('audio-status-text-' + sectionId);
      
      if (audioPlayer) {
          const wasPlaying = !audioPlayer.paused;
          audioPlayer.src = audioSources[newRpm];
          
          if (wasPlaying) {
              audioPlayer.play().then(() => {
                  if (!isFallbackMode) drawVisualization();
                  else simulateVisualization();
              }).catch(e => {
                  console.warn("Switch play interrupted", e);
                  enableFallbackMode(); 
                  audioPlayer.play().then(() => simulateVisualization());
              });
              if (statusText) statusText.textContent = "PLAYING: " + currentRpm.toUpperCase();
          } else {
             if (statusText) statusText.textContent = "READY: " + currentRpm.toUpperCase();
          }
      }
    });
  });
  
  // Detect load error on audio element (CORS often triggers error listener)
  const player = document.getElementById('audio-player-' + sectionId);
  if (player) {
      player.addEventListener('error', (e) => {
          console.warn("Audio error:", player.error);
          enableFallbackMode();
          if (isPlaying) { // Try to recover playback
             const statusText = document.getElementById('audio-status-text-' + sectionId);
             player.play().catch(err => {
                 statusText.textContent = "ERROR LOADING AUDIO";
                 onPause(sectionId);
             }); 
          }
      });
  }
})();
</script>

<style>
  @keyframes scan {
    0% { left: 0; }
    100% { left: 100%; }
  }
  
  .animate-scan {
    animation: scan 3s linear infinite;
  }
  
  .rpm-toggle.active {
    border-color: #CC0000;
    color: #CC0000;
  }
</style>

{% schema %}
{
  "name": "Sonic Laboratory",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "THE SONIC LABORATORY"
    },
    {
      "type": "header",
      "content": "Audio Configuration (Shopify Hosted)"
    },
    {
      "type": "paragraph",
      "content": "For best results (and real-time visualization), upload your .mp3 files to Shopify Admin > Content > Files. Then copy the link and paste it below. External links (like GitHub) may cause CORS errors and default to 'Simulation Mode'."
    },
    {
      "type": "url",
      "id": "audio_idle",
      "label": "Idle Audio URL",
      "info": "Paste the Link from Shopify Files."
    },
    {
      "type": "url",
      "id": "audio_3000",
      "label": "3000 RPM Audio URL",
      "info": "Paste the Link from Shopify Files."
    },
    {
      "type": "url",
      "id": "audio_redline",
      "label": "Redline Audio URL",
      "info": "Paste the Link from Shopify Files."
    },
    {
      "type": "url",
      "id": "audio_url",
      "label": "Legacy Audio (Fallback)",
      "info": "Used if specific tracks above are not set."
    }
  ],
  "blocks": [
    {
      "type": "spec",
      "name": "Metric",
      "settings": [
        {
          "type": "text",
          "id": "value",
          "label": "Value",
          "default": "110dB"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Raw Output"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Sonic Laboratory",
      "blocks": [
        {
          "type": "spec",
          "settings": {
            "value": "110dB",
            "label": "Peak Output"
          }
        },
        {
          "type": "spec",
          "settings": {
            "value": "+25 HP",
            "label": "Dyno Verified Gain"
          }
        }
      ]
    }
  ]
}
{% endschema %}
