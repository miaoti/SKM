{% comment %}
  Main Product Precision - "Technical Command Center" Design
  Porsche-inspired clean, authoritative, precise aesthetic
{% endcomment %}

<script>
  // Expose compatible vehicles to JS
  window.productCompatibleVehicles = [
    {%- if product.metafields.custom.fits_vehicles.value != blank -%}
      {%- for vehicle in product.metafields.custom.fits_vehicles.value -%}
        "{{ vehicle.system.id }}",
      {%- endfor -%}
    {%- endif -%}
  ];
</script>

{% comment %} Product JSON for variant media filter {% endcomment %}
<script type="application/json" data-product-json>
  {{ product | json }}
</script>

{% comment %} Technical Command Center Styles {% endcomment %}
<style>
  .tcc-page {
    --tcc-obsidian: #111111;
    --tcc-white: #FFFFFF;
    --tcc-red: #CC0000;
    --tcc-border: #E5E5E5;
    --tcc-grey-light: #F8F8F8;
    --tcc-grey-text: #666666;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }
  
  /* Thumbnail Gallery */
  .tcc-gallery {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: 16px;
    height: fit-content;
  }
  
  .tcc-thumbnails {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 600px;
    overflow-y: auto;
    scrollbar-width: thin;
  }
  
  .tcc-thumbnail {
    width: 80px;
    height: 80px;
    border: 0.5px solid var(--tcc-border);
    cursor: pointer;
    opacity: 0.6;
    transition: all 0.3s ease;
    overflow: hidden;
    flex-shrink: 0;
  }
  
  .tcc-thumbnail:hover,
  .tcc-thumbnail.active {
    opacity: 1;
    border-color: var(--tcc-obsidian);
  }
  
  .tcc-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .tcc-main-image {
    position: relative;
    border: 1px solid var(--tcc-border);
    background: var(--tcc-white);
    overflow: hidden;
  }
  
  .tcc-main-image img,
  .tcc-main-image .product-media {
    width: 100%;
    height: auto;
    object-fit: contain;
    transition: opacity 0.4s ease;
  }
  
  .tcc-main-image .media-hidden {
    opacity: 0;
    position: absolute;
    pointer-events: none;
  }
  
  /* Glassmorphism Control Panel */
  .tcc-control-panel {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 0.5px solid var(--tcc-border);
    padding: 32px;
  }
  
  /* Typography */
  .tcc-title {
    font-family: 'Helvetica Neue', 'Arial', sans-serif;
    font-size: 32px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: -0.02em;
    color: var(--tcc-obsidian);
    margin: 0 0 8px 0;
    line-height: 1.1;
  }
  
  .tcc-spec-id {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 12px;
    color: var(--tcc-grey-text);
    margin-bottom: 24px;
  }
  
  /* Pricing Module */
  .tcc-pricing {
    display: flex;
    align-items: baseline;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }
  
  .tcc-price-main {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--tcc-obsidian);
  }
  
  .tcc-price-crossed {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 16px;
    color: var(--tcc-grey-text);
    text-decoration: line-through;
  }
  
  .tcc-badge-wholesale {
    display: inline-block;
    border: 1px solid var(--tcc-red);
    color: var(--tcc-red);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    padding: 4px 10px;
    letter-spacing: 0.1em;
  }
  
  .tcc-badge-delta {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 12px;
    color: #16a34a;
    font-weight: 600;
  }
  
  /* Availability */
  .tcc-availability {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 11px;
    color: var(--tcc-grey-text);
    margin-bottom: 24px;
    padding: 12px 0;
    border-top: 0.5px solid var(--tcc-border);
    border-bottom: 0.5px solid var(--tcc-border);
  }
  
  .tcc-availability .in-stock {
    color: #16a34a;
    font-weight: 600;
  }
  
  .tcc-availability .out-of-stock {
    color: var(--tcc-red);
    font-weight: 600;
  }
  
  /* Technical Brief Section (Full Width) */
  .tcc-tech-brief-section {
    margin-top: 48px;
    padding-top: 32px;
    border-top: 0.5px solid var(--tcc-border);
  }
  
  .tcc-tech-brief-header {
    font-family: 'JetBrains Mono', 'Consolas', monospace;
    font-size: 11px;
    color: var(--tcc-red);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 20px;
  }
  
  .tcc-tech-brief-content {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.7;
    color: #333;
  }
  
  .tcc-tech-brief-content p {
    margin-bottom: 16px;
  }
  
  .tcc-tech-brief-content ul,
  .tcc-tech-brief-content ol {
    margin-left: 20px;
    margin-bottom: 16px;
  }
  
  /* Mobile Responsive */
  @media (max-width: 1024px) {
    .tcc-gallery {
      grid-template-columns: 1fr;
    }
    
    .tcc-thumbnails {
      flex-direction: row;
      max-height: none;
      overflow-x: auto;
      order: 2;
    }
    
    .tcc-main-image {
      order: 1;
    }
    
    .tcc-control-panel {
      position: relative !important;
      top: auto !important;
    }
  }
</style>

<div class="tcc-page min-h-screen bg-white text-black">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-[60%_40%] gap-8 lg:gap-12">
      
      <!-- LEFT: MEDIA GALLERY (60%) -->
      <div class="tcc-gallery" data-product-media-container>
        <!-- Thumbnail Rail -->
        <div class="tcc-thumbnails">
          {%- if product.media.size > 0 -%}
            {%- for media in product.media -%}
              <button 
                class="tcc-thumbnail {% if forloop.first %}active{% endif %}" 
                data-thumbnail-btn
                data-media-index="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                data-media-alt="{{ media.alt | escape | downcase }}"
                aria-label="View image {{ forloop.index }}"
              >
                <img 
                  src="{{ media.preview_image | image_url: width: 160 }}" 
                  alt="{{ media.alt | escape }}"
                  loading="lazy"
                >
              </button>
            {%- endfor -%}
          {%- endif -%}
        </div>
        
        <!-- Main Viewport -->
        <div class="tcc-main-image">
          {%- if product.media.size > 0 -%}
            {%- for media in product.media -%}
              <div 
                class="tcc-media-slide {% unless forloop.first %}media-hidden{% endunless %}" 
                data-media-slide 
                data-media-index="{{ forloop.index0 }}"
                data-media-id="{{ media.id }}"
                data-media-alt="{{ media.alt | escape | downcase }}"
              >
                {% render 'product-media', 
                  media: media, 
                  loop: section.settings.enable_video_looping, 
                  variant_image: false,
                  loading: forloop.first | ternary: 'eager', 'lazy',
                  widths: '550, 750, 1100, 1500, 2000'
                %}
              </div>
            {%- endfor -%}
          {%- else -%}
            <div class="flex items-center justify-center h-full text-gray-400">
              {{ 'product-1' | placeholder_svg_tag: 'w-1/3 h-1/3' }}
            </div>
          {%- endif -%}
        </div>
      </div>

      <!-- RIGHT: CONTROL PANEL (40%) -->
      <div class="tcc-control-panel lg:sticky lg:top-8 h-fit">
        
        <!-- Header: Title + SPEC_ID -->
        <h1 class="tcc-title">{{ product.title }}</h1>
        <div class="tcc-spec-id" id="product-sku-display">
          {%- if product.selected_or_first_available_variant.sku != blank -%}
            [ SPEC_ID: <span class="text-black font-semibold">{{ product.selected_or_first_available_variant.sku }}</span> ]
          {%- else -%}
            [ SPEC_ID: {{ product.id }} ]
          {%- endif -%}
        </div>

        <!-- Pricing Module (Logic Preserved) -->
        {%- liquid
          assign selected_variant = product.selected_or_first_available_variant
          assign original_price = selected_variant.price
          assign compare_at_price = selected_variant.compare_at_price
          
          assign variant_b2b_price_raw = selected_variant.metafields.custom.b2b_price.value
          assign product_b2b_price_raw = product.metafields.custom.b2b_price.value
          assign variant_discount_price_raw = selected_variant.metafields.custom.discount_price.value
          assign product_discount_price_raw = product.metafields.custom.discount_price.value
          
          assign b2b_price_raw = variant_b2b_price_raw
          if b2b_price_raw == blank or b2b_price_raw == empty
            assign b2b_price_raw = product_b2b_price_raw
          endif
          
          assign discount_price_raw = variant_discount_price_raw
          if discount_price_raw == blank or discount_price_raw == empty
            assign discount_price_raw = product_discount_price_raw
          endif
          
          assign b2b_price = nil
          assign discount_price = nil
          
          if b2b_price_raw != blank and b2b_price_raw != empty
            assign b2b_price = b2b_price_raw | times: 100
          endif
          
          if discount_price_raw != blank and discount_price_raw != empty
            assign discount_price = discount_price_raw | times: 100
          endif
          
          assign is_b2b_user = false
          if customer
            for tag in customer.tags
              assign tag_downcase = tag | downcase | strip
              if tag_downcase == 'b2b' or tag_downcase == 'wholesale' or tag_downcase == 'business'
                assign is_b2b_user = true
                break
              endif
            endfor
          endif
          
          assign display_price = original_price
          assign crossed_out_price = nil
          assign price_badge = nil
          assign is_wholesale = false
          assign percent_off = 0
          assign show_crossed_price = false
          
          if is_b2b_user
            if discount_price != nil and b2b_price != nil
              if b2b_price <= discount_price
                assign display_price = b2b_price
                assign crossed_out_price = original_price
                assign price_badge = 'WHOLESALE'
                assign is_wholesale = true
              else
                assign display_price = discount_price
                assign crossed_out_price = original_price
                assign price_diff = original_price | minus: discount_price
                assign percent_off = price_diff | times: 100 | divided_by: original_price | round
              endif
              assign show_crossed_price = true
            elsif b2b_price != nil
              assign display_price = b2b_price
              assign crossed_out_price = original_price
              assign price_badge = 'WHOLESALE'
              assign is_wholesale = true
              assign show_crossed_price = true
            elsif discount_price != nil
              assign display_price = discount_price
              assign crossed_out_price = original_price
              assign price_diff = original_price | minus: discount_price
              assign percent_off = price_diff | times: 100 | divided_by: original_price | round
              assign show_crossed_price = true
            endif
          else
            if discount_price != nil
              assign display_price = discount_price
              assign crossed_out_price = original_price
              assign price_diff = original_price | minus: discount_price
              assign percent_off = price_diff | times: 100 | divided_by: original_price | round
              assign show_crossed_price = true
            elsif compare_at_price > original_price
              assign crossed_out_price = compare_at_price
              assign price_diff = compare_at_price | minus: original_price
              assign percent_off = price_diff | times: 100 | divided_by: compare_at_price | round
              assign show_crossed_price = true
            endif
          endif
        -%}
        
        <div class="tcc-pricing" id="product-price-display">
          {%- if show_crossed_price and crossed_out_price -%}
            <span class="tcc-price-crossed" data-compare-price>{{ crossed_out_price | money }}</span>
          {%- endif -%}
          <span class="tcc-price-main" data-product-price>{{ display_price | money }}</span>
          {%- if is_wholesale -%}
            <span class="tcc-badge-wholesale">WHOLESALE</span>
          {%- elsif percent_off > 0 -%}
            <span class="tcc-badge-delta">Î” -{{ percent_off }}%</span>
          {%- endif -%}
        </div>

        <!-- Availability -->
        <div class="tcc-availability" id="product-availability-display">
          STATUS: 
          {%- if product.selected_or_first_available_variant.available -%}
            <span class="in-stock">IN_STOCK</span> // QTY: <span id="product-inventory-count">{{ product.selected_or_first_available_variant.inventory_quantity | default: '1+' }}</span>
          {%- else -%}
            <span class="out-of-stock">OUT_OF_STOCK</span>
          {%- endif -%}
        </div>
        
        <!-- Buy Buttons -->
        {%- render 'buy-buttons-precision', product: product, product_form_id: 'product-form-' | append: section.id -%}

      </div>
    </div>
    
    <!-- Technical Brief Section (Full Width) -->
    {%- if product.description != blank -%}
      <div class="tcc-tech-brief-section">
        <div class="tcc-tech-brief-header">[ TECHNICAL_BRIEF ]</div>
        <div class="tcc-tech-brief-content">
          {{ product.description }}
        </div>
      </div>
    {%- endif -%}
    
  </div>
</div>

<!-- Gallery Interaction + Variant Filter Script -->
<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('[data-thumbnail-btn]');
    const slides = document.querySelectorAll('[data-media-slide]');
    
    // Click handler for thumbnails
    function activateThumbnail(thumb) {
      const index = thumb.dataset.mediaIndex;
      
      // Update thumbnail active state
      thumbnails.forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
      
      // Cross-fade slides
      slides.forEach(function(slide) {
        if (slide.dataset.mediaIndex === index) {
          slide.classList.remove('media-hidden');
        } else {
          slide.classList.add('media-hidden');
        }
      });
    }
    
    thumbnails.forEach(function(thumb) {
      thumb.addEventListener('click', function() {
        activateThumbnail(this);
      });
    });
    
    // Variant media filtering
    function filterMediaByVariant() {
      // Get selected option values (check Material option specifically for this product)
      const selectedValues = [];
      
      document.querySelectorAll('fieldset.variant-option-group').forEach(function(fieldset) {
        const checkedInput = fieldset.querySelector('input[type="radio"]:checked');
        if (checkedInput && checkedInput.value) {
          selectedValues.push(checkedInput.value.toLowerCase().trim());
        }
      });
      
      // Also check for addon options but don't filter by them
      // Only filter by variant options (like Material)
      
      if (selectedValues.length === 0) {
        // No variant selected, show all
        thumbnails.forEach(t => t.style.display = '');
        slides.forEach(s => s.style.display = '');
        return;
      }
      
      let hasMatchingMedia = false;
      let firstMatchingThumb = null;
      
      thumbnails.forEach(function(thumb, idx) {
        const alt = (thumb.dataset.mediaAlt || '').toLowerCase().trim();
        const slide = slides[idx];
        
        // Check if media alt contains any selected option value
        let matches = false;
        
        if (alt === '') {
          // Untagged media - show it
          matches = true;
        } else {
          // Check if alt text matches any selected variant
          matches = selectedValues.some(val => alt.includes(val));
        }
        
        if (matches) {
          thumb.style.display = '';
          if (slide) slide.style.display = '';
          hasMatchingMedia = true;
          if (!firstMatchingThumb) firstMatchingThumb = thumb;
        } else {
          thumb.style.display = 'none';
          if (slide) slide.style.display = 'none';
        }
      });
      
      // If no matching media found, show all
      if (!hasMatchingMedia) {
        thumbnails.forEach(t => t.style.display = '');
        slides.forEach(s => s.style.display = '');
        firstMatchingThumb = thumbnails[0];
      }
      
      // Activate first matching thumbnail
      if (firstMatchingThumb && !firstMatchingThumb.classList.contains('active')) {
        activateThumbnail(firstMatchingThumb);
      }
    }
    
    // Listen for variant changes
    document.querySelectorAll('input[type="radio"][name*="option"]').forEach(input => {
      input.addEventListener('change', filterMediaByVariant);
    });
    
    // Also listen on the form for any changes
    const form = document.querySelector('form[action*="/cart/add"]');
    if (form) {
      form.addEventListener('change', function(e) {
        if (e.target.matches('input[type="radio"][name*="option"]')) {
          filterMediaByVariant();
        }
      });
    }
    
    // Initial filter
    filterMediaByVariant();
  });
})();
</script>

{% schema %}
{
  "name": "Product Precision",
  "tag": "section",
  "class": "section",
  "blocks": [],
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "default": false,
      "label": "Enable video looping"
    }
  ],
  "presets": [
    {
      "name": "Product Precision"
    }
  ]
}
{% endschema %}
