<!-- =========================================
     METALLURGY & ASSEMBLY: Exploded View Archive
     Technical hotspots revealing engineering details
========================================== -->

<div class="py-24 bg-white relative overflow-hidden">
  <!-- Blueprint Grid Background -->
  <div class="absolute inset-0 blueprint-grid opacity-30"></div>
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    
    <!-- Section Header -->
    <div class="mb-12 text-center">
      <div class="hud-spec-label mb-3">[ COMPONENT_ANALYSIS ]</div>
      <h2 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight" style="font-family: 'Helvetica Now Display', Inter, sans-serif;">
        {{ section.settings.heading | default: "METALLURGY & ASSEMBLY" }}
      </h2>
      <p class="mt-4 text-gray-500 hud-mono text-sm max-w-2xl mx-auto">
        Every component engineered for precision. Hover to analyze individual elements.
      </p>
    </div>
    
    <!-- Exploded View Container -->
    <div class="relative w-full aspect-[16/9] rounded-none overflow-visible bg-gradient-to-b from-gray-50 to-white border border-gray-200">
      
      <!-- Main Image -->
      {%- if section.settings.image != blank -%}
        {{ section.settings.image | image_url: width: 2000 | image_tag: class: "w-full h-full object-contain" }}
      {%- else -%}
        <div class="w-full h-full flex items-center justify-center">
          {{ 'lifestyle-1' | placeholder_svg_tag: 'w-3/4 h-3/4 object-contain opacity-30' }}
          <div class="absolute inset-0 flex items-center justify-center">
            <p class="hud-mono text-sm text-gray-400">[ UPLOAD_EXPLODED_VIEW_IMAGE ]</p>
          </div>
        </div>
      {%- endif -%}

      <!-- Technical Hotspots -->
      {%- for block in section.blocks -%}
        <div class="hotspot-container absolute" 
             id="hotspot-{{ section.id }}-{{ forloop.index }}"
             data-hotspot-index="{{ forloop.index }}"
             style="top: {{ block.settings.top }}%; left: {{ block.settings.left }}%;"
             {{ block.shopify_attributes }}>
          
          <!-- Pulsing Hotspot -->
          <div class="relative flex items-center justify-center w-10 h-10 cursor-pointer hotspot-trigger"
               onclick="toggleHotspot('{{ section.id }}', {{ forloop.index }})">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#CC0000] opacity-40"></span>
            <span class="relative inline-flex rounded-full h-4 w-4 bg-[#CC0000] border-2 border-white shadow-lg"></span>
            
            <!-- Connector Line -->
            <div class="hotspot-connector absolute w-8 h-[1px] bg-[#CC0000] opacity-0 transition-opacity" 
                 style="left: 100%; top: 50%;"></div>
          </div>
          
          <!-- Technical Tooltip -->
          <div class="hotspot-tooltip absolute z-20 opacity-0 invisible transition-all duration-300
                      {% if block.settings.left > 50 %}right-full mr-4{% else %}left-full ml-4{% endif %}
                      top-1/2 -translate-y-1/2">
            <div class="bg-black text-white p-5 text-sm w-72 shadow-2xl border border-[#CC0000]/30 relative">
              
              <!-- Tooltip Header -->
              <div class="flex items-center gap-2 mb-3 pb-3 border-b border-white/10">
                <div class="w-2 h-2 bg-[#CC0000]"></div>
                <span class="hud-spec-label text-[#CC0000]">{{ block.settings.code | default: "COMPONENT_01" }}</span>
              </div>
              
              <!-- Tooltip Title -->
              <h4 class="font-bold text-white uppercase mb-2 tracking-wide">{{ block.settings.title }}</h4>
              
              <!-- Tooltip Description -->
              <p class="text-gray-400 text-xs leading-relaxed mb-4">{{ block.settings.text }}</p>
              
              <!-- Technical Specs -->
              {%- if block.settings.specs != blank -%}
                <div class="hud-mono text-[10px] text-[#CC0000] border-t border-white/10 pt-3">
                  {{ block.settings.specs }}
                </div>
              {%- endif -%}
              
              <!-- Arrow -->
              <div class="absolute top-1/2 -translate-y-1/2
                          {% if block.settings.left > 50 %}
                            -right-2 border-l-8 border-l-black border-y-8 border-y-transparent
                          {% else %}
                            -left-2 border-r-8 border-r-black border-y-8 border-y-transparent
                          {% endif %}">
              </div>
            </div>
          </div>
        </div>
      {%- endfor -%}
      
      <!-- Corner Annotations with backdrop for readability -->
      <div class="absolute top-4 left-4 hud-mono text-[10px] text-white bg-black/60 px-2 py-1 rounded backdrop-blur-sm">
        REV: 2.0 | SCALE: 1:1
      </div>
      <div class="absolute top-4 right-4 hud-mono text-[10px] text-white bg-black/60 px-2 py-1 rounded backdrop-blur-sm">
        DWG: SKM-EX-001
      </div>
      <div class="absolute bottom-4 left-4 hud-mono text-[10px] text-white bg-black/60 px-2 py-1 rounded backdrop-blur-sm">
        MATERIAL: 304 STAINLESS STEEL
      </div>
      <div class="absolute bottom-4 right-4 hud-mono text-[10px] text-white bg-black/60 px-2 py-1 rounded backdrop-blur-sm">
        TOLERANCE: Â±0.5mm
      </div>
    </div>
    
    <!-- Component Legend -->
    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {%- for block in section.blocks limit: 4 -%}
        <div class="legend-item p-4 border border-gray-200 bg-white hover:border-[#CC0000] transition-colors cursor-pointer group"
             onclick="activateHotspot('{{ section.id }}', {{ forloop.index }})"
             data-legend-index="{{ forloop.index }}">
          <div class="flex items-start gap-3">
            <div class="w-3 h-3 bg-[#CC0000] mt-1 flex-shrink-0"></div>
            <div>
              <div class="hud-spec-label text-[9px] mb-1">{{ block.settings.code | default: "COMPONENT" }}</div>
              <h5 class="font-bold text-gray-900 text-sm uppercase group-hover:text-[#CC0000] transition-colors">{{ block.settings.title }}</h5>
            </div>
          </div>
        </div>
      {%- endfor -%}
    </div>
    
  </div>
</div>

<!-- Hotspot Click Interaction Scripts -->
<script>
  // Track active hotspot per section
  const activeHotspots = {};
  
  // Toggle hotspot tooltip when clicking on the hotspot dot
  function toggleHotspot(sectionId, index) {
    const hotspot = document.getElementById('hotspot-' + sectionId + '-' + index);
    if (!hotspot) return;
    
    const tooltip = hotspot.querySelector('.hotspot-tooltip');
    const connector = hotspot.querySelector('.hotspot-connector');
    
    // Close any other open hotspots in this section
    if (activeHotspots[sectionId] && activeHotspots[sectionId] !== index) {
      closeHotspot(sectionId, activeHotspots[sectionId]);
    }
    
    // Toggle this hotspot
    if (tooltip.classList.contains('opacity-100')) {
      // Close it
      tooltip.classList.remove('opacity-100', 'visible');
      tooltip.classList.add('opacity-0', 'invisible');
      connector.classList.remove('opacity-100');
      connector.classList.add('opacity-0');
      activeHotspots[sectionId] = null;
    } else {
      // Open it
      tooltip.classList.add('opacity-100', 'visible');
      tooltip.classList.remove('opacity-0', 'invisible');
      connector.classList.add('opacity-100');
      connector.classList.remove('opacity-0');
      activeHotspots[sectionId] = index;
    }
  }
  
  // Close a specific hotspot
  function closeHotspot(sectionId, index) {
    const hotspot = document.getElementById('hotspot-' + sectionId + '-' + index);
    if (!hotspot) return;
    
    const tooltip = hotspot.querySelector('.hotspot-tooltip');
    const connector = hotspot.querySelector('.hotspot-connector');
    
    tooltip.classList.remove('opacity-100', 'visible');
    tooltip.classList.add('opacity-0', 'invisible');
    connector.classList.remove('opacity-100');
    connector.classList.add('opacity-0');
  }
  
  // Activate hotspot from legend click (scroll and show)
  function activateHotspot(sectionId, index) {
    const hotspot = document.getElementById('hotspot-' + sectionId + '-' + index);
    if (!hotspot) return;
    
    // Scroll the hotspot into view
    hotspot.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // After scrolling, toggle the hotspot
    setTimeout(() => {
      // Close any other open hotspots
      if (activeHotspots[sectionId] && activeHotspots[sectionId] !== index) {
        closeHotspot(sectionId, activeHotspots[sectionId]);
      }
      
      // Open this hotspot
      const tooltip = hotspot.querySelector('.hotspot-tooltip');
      const connector = hotspot.querySelector('.hotspot-connector');
      
      tooltip.classList.add('opacity-100', 'visible');
      tooltip.classList.remove('opacity-0', 'invisible');
      connector.classList.add('opacity-100');
      connector.classList.remove('opacity-0');
      activeHotspots[sectionId] = index;
      
      // Highlight the legend item
      document.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('border-[#CC0000]', 'bg-red-50');
      });
      const legendItem = document.querySelector('[data-legend-index="' + index + '"]');
      if (legendItem) {
        legendItem.classList.add('border-[#CC0000]', 'bg-red-50');
      }
    }, 400);
  }
  
  // Close hotspots when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.hotspot-container') && !e.target.closest('.legend-item')) {
      // Close all active hotspots
      Object.keys(activeHotspots).forEach(sectionId => {
        if (activeHotspots[sectionId]) {
          closeHotspot(sectionId, activeHotspots[sectionId]);
          activeHotspots[sectionId] = null;
        }
      });
      // Remove legend highlights
      document.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('border-[#CC0000]', 'bg-red-50');
      });
    }
  });
</script>

{% schema %}
{
  "name": "Metallurgy & Assembly",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "METALLURGY & ASSEMBLY"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Exploded View Image"
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "Component Hotspot",
      "settings": [
        {
          "type": "range",
          "id": "top",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Vertical Position",
          "default": 50
        },
        {
          "type": "range",
          "id": "left",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Horizontal Position",
          "default": 50
        },
        {
          "type": "text",
          "id": "code",
          "label": "Component Code",
          "default": "WELD_01"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "TIG Precision Weld"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Description",
          "default": "Hand-welded joints using argon-purged TIG welding for superior strength and aesthetics."
        },
        {
          "type": "text",
          "id": "specs",
          "label": "Technical Specs",
          "default": "TECH: TIG_PRECISION // GAS: ARGON_PURGE"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Metallurgy & Assembly",
      "blocks": [
        {
          "type": "hotspot",
          "settings": {
            "top": 35,
            "left": 60,
            "code": "WELD_01",
            "title": "TIG Precision Weld",
            "text": "Hand-welded joints using argon-purged TIG welding for superior penetration and aesthetic finish.",
            "specs": "TECH: TIG_PRECISION // GAS: ARGON_PURGE"
          }
        },
        {
          "type": "hotspot",
          "settings": {
            "top": 55,
            "left": 30,
            "code": "VALVE_01",
            "title": "Exhaust Valve Assembly",
            "text": "Electronic butterfly valve for active sound management. Compatible with B2B dealership control systems.",
            "specs": "CONTROL: ECU_INTEGRATED // VOLTAGE: 12V DC"
          }
        },
        {
          "type": "hotspot",
          "settings": {
            "top": 70,
            "left": 75,
            "code": "FLANGE_01",
            "title": "304SS Mounting Flange",
            "text": "Precision-machined flange with integrated gasket groove for leak-free connection.",
            "specs": "GRADE: 304L // SURFACE: #4 BRUSHED"
          }
        }
      ]
    }
  ]
}
{% endschema %}
